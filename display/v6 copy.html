<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Video Player Mobile</title>
    <!-- CSS BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="v6.css">
    <script src="configDisplay.js"></script>
    </head>

<body>
    <div id="showKey">
        mostra chave de acesso
        <br>
        chave abc123
    </div>

    <div id="showPlay">
        <div id="showPlaySuperior">
           <!-- Player principal -->
           <video id="mainVideo" autoplay muted playsinline webkit-playsinline preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
            Seu navegador n√£o suporta o elemento de v√≠deo.
           </video>
           <!-- Player buffer oculto para pr√≥xima m√≠dia -->
           <video id="bufferVideo" muted playsinline webkit-playsinline preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; pointer-events: none;">
           </video>
        </div>
        <div id="showPlayInferior">
            <div class="coluna-esquerda padding: 20px margin: 20px" >
                <img id="logoDispositivo" src="" alt="Logo" style="display: none; max-height: 60px; max-width: 150px; object-fit: contain;">
            </div>
            <div class="coluna-direita">
                <span class="textoInferior">
                    ANUNCIE AQUI! (85) 99445.4472
                </span>
            </div>
        </div>
        
        <!-- Indicador de preload -->
        <div id="preloadIndicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <!-- Logo da empresa -->
            <div class="loading-logo">
                <img src="../public/img/logo.png" alt="Logo Vix M√≠dia" style="max-width: 360px; max-height: 216px; object-fit: contain;" >
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <div id="preloadText" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Carregando m√≠dias...</div>
                <div id="preloadCounter" style="font-size: 18px; opacity: 0.8;">0 / 0</div>
                <div style="width: 300px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; margin: 15px auto; overflow: hidden;">
                    <div id="preloadProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00D4AA, #00A8CC); border-radius: 4px; transition: width 0.3s ease;"></div>
                </div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 10px;">Preparando playlist...</div>
            </div>
        </div>
    </div>

    <script src="configDisplay.js"></script>
    <script>
        // Compatibilidade com Android e verifica√ß√£o de chave
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.querySelector('video');
            const showKey = document.getElementById('showKey');
            const showPlay = document.getElementById('showPlay');
            
            // Registra o Service Worker para cache offline
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                        
                        // Escuta atualiza√ß√µes do Service Worker
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Nova vers√£o do Service Worker dispon√≠vel');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao registrar Service Worker:', error);
                    });
            }
            
            // Adiciona listener para combina√ß√£o de teclas Ctrl+Shift+C para limpar cache
            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.shiftKey && event.key === 'C') {
                    event.preventDefault();
                    
                    if (confirm('Deseja limpar todo o cache offline?\n\nIsso remover√° todas as m√≠dias e dados salvos localmente.')) {
                        const removedItems = limparTodoCache();
                        
                        // Limpa tamb√©m o Service Worker cache se dispon√≠vel
                        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                            const messageChannel = new MessageChannel();
                            messageChannel.port1.onmessage = function(event) {
                                if (event.data.success) {
                                    console.log('Service Worker cache limpo com sucesso');
                                } else {
                                    console.error('Erro ao limpar Service Worker cache');
                                }
                            };
                            
                            navigator.serviceWorker.controller.postMessage({
                                type: 'CLEAR_CACHE'
                            }, [messageChannel.port2]);
                        }
                        
                        alert(`Cache limpo com sucesso!\n\n${removedItems} itens removidos do localStorage.\nService Worker cache tamb√©m foi limpo.`);
                        
                        // Recarrega a p√°gina para aplicar as mudan√ßas
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                }
            });
            
            // Monitora status da conex√£o
            let isOnline = navigator.onLine;
            
            window.addEventListener('online', () => {
                isOnline = true;
                console.log('Conex√£o restaurada');
                
                // Remove indicador offline
                const offlineIndicator = document.getElementById('offlineIndicator');
                if (offlineIndicator) {
                    offlineIndicator.style.background = 'rgba(0, 200, 0, 0.9)';
                    offlineIndicator.innerHTML = 'üì° ONLINE';
                    setTimeout(() => offlineIndicator.remove(), 3000);
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                console.log('Conex√£o perdida - modo offline');
                adicionarIndicadorOffline();
            });
            
            // Fun√ß√£o para gerar chave √∫nica baseada no navegador
            function gerarChaveUnica() {
                // Tenta obter uma chave j√° existente no localStorage
                let chaveExistente = localStorage.getItem('deviceKey');
                if (chaveExistente) {
                    return chaveExistente;
                }
                
                // Se n√£o existe, gera uma nova baseada em caracter√≠sticas do navegador
                const navegadorInfo = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    navigator.platform
                ].join('|');
                
                // Gera hash simples da string
                let hash = 0;
                for (let i = 0; i < navegadorInfo.length; i++) {
                    const char = navegadorInfo.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Converte para 32bit
                }
                
                // Converte hash para chave de 6 caracteres
                const caracteres = 'ABCDEF0123456789';
                let chave = '';
                let hashAbs = Math.abs(hash);
                
                for (let i = 0; i < 6; i++) {
                    chave += caracteres.charAt(hashAbs % caracteres.length);
                    hashAbs = Math.floor(hashAbs / caracteres.length);
                }
                
                // Se a chave ficou muito curta, completa com caracteres aleat√≥rios
                while (chave.length < 6) {
                    chave += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
                }
                
                return chave;
            }
            
            // Fun√ß√£o para verificar chave na API com fallback offline
            async function verificarChave(deviceKey) {
                try {
                    const response = await fetch(`http://192.168.0.120:4000/public/device/${deviceKey}`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Dispositivo encontrado:', data);
                        
                        // Salva os dados no cache para uso offline
                        await salvarDadosCache(deviceKey, data);
                        
                        return data; // Retorna os dados completos incluindo medias
                    } else {
                        console.log('Dispositivo n√£o encontrado, tentando cache offline...');
                        return await carregarDadosCache(deviceKey);
                    }
                } catch (error) {
                    console.error('Erro ao verificar chave, usando cache offline:', error);
                    return await carregarDadosCache(deviceKey);
                }
            }
            
            // Fun√ß√£o para salvar dados no cache offline
            async function salvarDadosCache(deviceKey, data) {
                try {
                    // Salva os dados do dispositivo
                    localStorage.setItem(`device_${deviceKey}`, JSON.stringify(data));
                    localStorage.setItem(`device_${deviceKey}_timestamp`, Date.now().toString());
                    
                    // Salva as URLs das m√≠dias para cache
                    if (data.panel && data.panel.medias) {
                        const mediaUrls = data.panel.medias.map(media => media.url);
                        localStorage.setItem(`device_${deviceKey}_media_urls`, JSON.stringify(mediaUrls));
                        
                        // Inicia o cache das m√≠dias em background
                        cachearMidiasOffline(data.panel.medias, deviceKey);
                    }
                    
                    console.log('Dados salvos no cache offline');
                } catch (error) {
                    console.error('Erro ao salvar dados no cache:', error);
                }
            }
            
            // Fun√ß√£o para carregar dados do cache offline
            async function carregarDadosCache(deviceKey) {
                try {
                    const cachedData = localStorage.getItem(`device_${deviceKey}`);
                    if (cachedData) {
                        const data = JSON.parse(cachedData);
                        const timestamp = localStorage.getItem(`device_${deviceKey}_timestamp`);
                        
                        console.log('Dados carregados do cache offline (timestamp:', new Date(parseInt(timestamp)), ')');
                        
                        // Carrega as m√≠dias do cache offline
                        data.panel.medias = await carregarMidiasCacheadas(deviceKey);
                        
                        return data;
                    }
                    return false;
                } catch (error) {
                    console.error('Erro ao carregar dados do cache:', error);
                    return false;
                }
            }
            
            // Fun√ß√£o para cachear m√≠dias offline usando IndexedDB
            async function cachearMidiasOffline(medias, deviceKey) {
                try {
                    console.log('Iniciando cache offline de', medias.length, 'm√≠dias...');
                    
                    for (let i = 0; i < medias.length; i++) {
                        const media = medias[i];
                        const cacheKey = `media_${deviceKey}_${i}`;
                        
                        // Verifica se a m√≠dia j√° est√° em cache
                        const cachedMedia = localStorage.getItem(cacheKey);
                        if (cachedMedia) {
                            console.log(`M√≠dia ${i + 1} j√° est√° em cache`);
                            continue;
                        }
                        
                        try {
                            // Baixa a m√≠dia
                            const response = await fetch(media.url);
                            if (response.ok) {
                                const blob = await response.blob();
                                const reader = new FileReader();
                                
                                reader.onload = function() {
                                    try {
                                        // Salva como base64 no localStorage (limitado, mas funcional)
                                        localStorage.setItem(cacheKey, reader.result);
                                        localStorage.setItem(`${cacheKey}_type`, blob.type);
                                        console.log(`M√≠dia ${i + 1} cacheada com sucesso`);
                                    } catch (storageError) {
                                        console.warn(`Erro ao salvar m√≠dia ${i + 1} no cache (provavelmente muito grande):`, storageError);
                                        // Para v√≠deos muito grandes, salva apenas a URL
                                        localStorage.setItem(`${cacheKey}_url`, media.url);
                                    }
                                };
                                
                                reader.readAsDataURL(blob);
                            }
                        } catch (mediaError) {
                            console.warn(`Erro ao cachear m√≠dia ${i + 1}:`, mediaError);
                            // Salva apenas a URL como fallback
                            localStorage.setItem(`${cacheKey}_url`, media.url);
                        }
                    }
                } catch (error) {
                    console.error('Erro no processo de cache offline:', error);
                }
            }
            
            // Fun√ß√£o para carregar m√≠dias do cache offline
            async function carregarMidiasCacheadas(deviceKey) {
                try {
                    const mediaUrls = JSON.parse(localStorage.getItem(`device_${deviceKey}_media_urls`) || '[]');
                    const mediasCache = [];
                    
                    for (let i = 0; i < mediaUrls.length; i++) {
                        const cacheKey = `media_${deviceKey}_${i}`;
                        const cachedData = localStorage.getItem(cacheKey);
                        const cachedUrl = localStorage.getItem(`${cacheKey}_url`);
                        
                        if (cachedData) {
                            // M√≠dia est√° cacheada como base64
                            mediasCache.push({
                                url: cachedData,
                                cached: true,
                                originalUrl: mediaUrls[i]
                            });
                        } else if (cachedUrl) {
                            // Apenas URL est√° cacheada
                            mediasCache.push({
                                url: cachedUrl,
                                cached: false,
                                originalUrl: mediaUrls[i]
                            });
                        } else {
                            // Fallback para URL original
                            mediasCache.push({
                                url: mediaUrls[i],
                                cached: false,
                                originalUrl: mediaUrls[i]
                            });
                        }
                    }
                    
                    console.log(`Carregadas ${mediasCache.length} m√≠dias do cache offline`);
                    return mediasCache;
                } catch (error) {
                    console.error('Erro ao carregar m√≠dias do cache:', error);
                    return [];
                }
            }
            
            // Fun√ß√£o para configurar layout baseado no showClienteInfo
            function configurarLayout(showClienteInfo, dadosDispositivo = null) {
                const showPlaySuperior = document.getElementById('showPlaySuperior');
                const showPlayInferior = document.getElementById('showPlayInferior');
                const logoDispositivo = document.getElementById('logoDispositivo');
                
                if (showClienteInfo === true) {
                    // Se showClienteInfo √© TRUE, mostra a div inferior ("ANUNCIE AQUI")
                    showPlayInferior.style.display = 'flex';
                    showPlaySuperior.style.height = '90%'; // Mant√©m altura padr√£o do CSS
                    
                    // Configura a logo do dispositivo se dispon√≠vel
                    if (dadosDispositivo && dadosDispositivo.user && dadosDispositivo.user.picture) {
                        logoDispositivo.src = dadosDispositivo.user.picture;
                        logoDispositivo.style.display = 'block';
                        console.log('Logo do dispositivo carregada:', dadosDispositivo.user.picture);
                    } else {
                        // Se n√£o h√° logo, esconde a imagem
                        logoDispositivo.style.display = 'none';
                        console.log('Nenhuma logo encontrada para o dispositivo');
                    }
                } else {
                    // Se showClienteInfo √© FALSE, esconde a div inferior e a superior ocupa toda a tela
                    showPlayInferior.style.display = 'none';
                    showPlaySuperior.style.height = '100%';
                }
            }
            
            // Fun√ß√£o para mostrar a div apropriada
            async function inicializarDisplay() {
                // Gera ou obt√©m a chave √∫nica do navegador
                let deviceKey = gerarChaveUnica();
                
                // Salva a chave no localStorage para persist√™ncia
                localStorage.setItem('deviceKey', deviceKey);
                
                // Verifica se a chave √© v√°lida na API
                const chaveValida = await verificarChave(deviceKey);
                
                if (chaveValida) {
                    // Chave v√°lida - mostra o player
                    showKey.style.display = 'none';
                    showPlay.style.display = 'block';
                    
                    // Configura o layout baseado no showClienteInfo do dispositivo
                    configurarLayout(chaveValida.device.showClienteInfo, chaveValida);
                    
                    // Adiciona indicador de modo offline se necess√°rio
                    adicionarIndicadorOffline();
                    
                    inicializarVideo(chaveValida.panel.medias);
                } else {
                    // Tenta carregar dados do cache offline
                    console.log('API indispon√≠vel, tentando carregar dados do cache...');
                    const dadosCache = await carregarDadosCache(deviceKey);
                    
                    if (dadosCache && dadosCache.panel && dadosCache.panel.medias && dadosCache.panel.medias.length > 0) {
                        // Dados encontrados no cache - mostra o player em modo offline
                        console.log('Dados encontrados no cache, iniciando em modo offline');
                        showKey.style.display = 'none';
                        showPlay.style.display = 'block';
                        
                        // Configura o layout baseado no showClienteInfo do dispositivo
                        configurarLayout(dadosCache.device.showClienteInfo, dadosCache);
                        
                        // Adiciona indicador de modo offline
                        adicionarIndicadorOffline();
                        
                        // Inicia reprodu√ß√£o com dados do cache
                        inicializarVideo(dadosCache.panel.medias);
                    } else {
                        // Sem dados no cache - mostra a tela de chave
                        console.log('Nenhum dado encontrado no cache');
                        showPlay.style.display = 'none';
                        showKey.style.display = 'block';
                        showKey.innerHTML = `
                            <div style="text-align: center;">
                                <h3>Chave de Acesso</h3>
                                <p><strong>${deviceKey}</strong></p>
                                <p>Registre esta chave no painel administrativo</p>
                                <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px;">Verificar Novamente</button>
                                <div style="margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 5px; font-size: 12px; color: #c62828;">
                                    <strong>Modo Offline:</strong> Sem conex√£o com a API<br>
                                    Nenhum dado encontrado no cache local<br>
                                    Conecte-se √† internet para registrar o dispositivo
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // Fun√ß√£o para adicionar indicador visual de modo offline
            function adicionarIndicadorOffline() {
                // Remove indicador existente
                const existingIndicator = document.getElementById('offlineIndicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                // Verifica se est√° usando dados do cache
                const deviceKey = localStorage.getItem('deviceKey');
                const timestamp = localStorage.getItem(`device_${deviceKey}_timestamp`);
                
                const offlineIndicator = document.createElement('div');
                offlineIndicator.id = 'offlineIndicator';
                offlineIndicator.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 165, 0, 0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 1000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                if (timestamp) {
                    const cacheDate = new Date(parseInt(timestamp));
                    const now = new Date();
                    const diffHours = Math.floor((now - cacheDate) / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((now - cacheDate) / (1000 * 60));
                    
                    let timeText;
                    if (diffHours > 0) {
                        timeText = `${diffHours}h`;
                    } else {
                        timeText = `${diffMinutes}m`;
                    }
                    
                    offlineIndicator.innerHTML = `üì° OFFLINE (${timeText})`;
                } else {
                    offlineIndicator.innerHTML = 'üì° OFFLINE';
                }
                
                // Adiciona evento de clique para mostrar detalhes do cache
                offlineIndicator.addEventListener('click', mostrarDetalhesCache);
                
                document.body.appendChild(offlineIndicator);
                
                // Remove o indicador ap√≥s 15 segundos se n√£o for clicado
                setTimeout(() => {
                    if (document.getElementById('offlineIndicator')) {
                        document.getElementById('offlineIndicator').remove();
                    }
                }, 15000);
            }
            
            // Fun√ß√£o para mostrar detalhes do cache
            async function mostrarDetalhesCache() {
                const deviceKey = localStorage.getItem('deviceKey');
                const timestamp = localStorage.getItem(`device_${deviceKey}_timestamp`);
                const mediaUrls = JSON.parse(localStorage.getItem(`device_${deviceKey}_media_urls`) || '[]');
                
                let cacheInfo = 'INFORMA√á√ïES DO CACHE\n\n';
                
                if (timestamp) {
                    const cacheDate = new Date(parseInt(timestamp));
                    cacheInfo += `√öltima atualiza√ß√£o: ${cacheDate.toLocaleString()}\n`;
                }
                
                cacheInfo += `M√≠dias em cache: ${mediaUrls.length}\n`;
                
                // Verifica quantas m√≠dias est√£o realmente cacheadas
                let cachedCount = 0;
                for (let i = 0; i < mediaUrls.length; i++) {
                    const cacheKey = `media_${deviceKey}_${i}`;
                    if (localStorage.getItem(cacheKey) || localStorage.getItem(`${cacheKey}_url`)) {
                        cachedCount++;
                    }
                }
                
                cacheInfo += `M√≠dias dispon√≠veis offline: ${cachedCount}\n`;
                
                // Calcula tamanho aproximado do cache
                let cacheSize = 0;
                for (let key in localStorage) {
                    if (key.startsWith(`device_${deviceKey}`) || key.startsWith(`media_${deviceKey}`)) {
                        cacheSize += localStorage[key].length;
                    }
                }
                
                const cacheSizeMB = (cacheSize / (1024 * 1024)).toFixed(2);
                cacheInfo += `Tamanho do cache: ~${cacheSizeMB} MB\n`;
                
                // Verifica Service Worker
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    cacheInfo += '\nService Worker: Ativo ‚úì';
                } else {
                    cacheInfo += '\nService Worker: Inativo ‚úó';
                }
                
                cacheInfo += '\n\n[Pressione Ctrl+Shift+C para limpar cache]';
                
                alert(cacheInfo);
            }
            
            // Vari√°veis da playlist
            let playlist = [];
            let currentMediaIndex = 0;
            
            // Array para armazenar m√≠dias precarregadas
            let preloadedMedias = [];
            let isPreloading = false;
            
            // Fun√ß√£o para precarregar todas as m√≠dias com suporte a cache
            async function preloadMedias(medias) {
                console.log('Iniciando preload de', medias.length, 'm√≠dias...');
                isPreloading = true;
                preloadedMedias = [];
                
                // Mostra o indicador de preload
                const preloadIndicator = document.getElementById('preloadIndicator');
                const preloadProgress = document.getElementById('preloadProgress');
                const preloadCounter = document.getElementById('preloadCounter');
                const preloadText = document.getElementById('preloadText');
                
                preloadIndicator.style.display = 'flex';
                preloadCounter.textContent = `0 / ${medias.length}`;
                preloadProgress.style.width = '0%';
                preloadText.textContent = 'Carregando m√≠dias...';
                
                let loadedCount = 0;
                let cachedCount = 0;
                
                const preloadPromises = medias.map((midia, index) => {
                    return new Promise((resolve, reject) => {
                        const videoElement = document.createElement('video');
                        videoElement.preload = 'auto';
                        videoElement.muted = true;
                        
                        // Verifica se a m√≠dia est√° em cache
                        const isCached = midia.cached === true;
                        if (isCached) {
                            cachedCount++;
                        }
                        
                        videoElement.addEventListener('loadeddata', () => {
                            const statusText = isCached ? '(cache)' : '(online)';
                            console.log(`M√≠dia ${index + 1}/${medias.length} precarregada ${statusText}:`, midia.url);
                            preloadedMedias[index] = {
                                element: videoElement,
                                url: midia.url,
                                originalData: midia,
                                cached: isCached
                            };
                            
                            // Atualiza o progresso visual
                            loadedCount++;
                            const progress = (loadedCount / medias.length) * 100;
                            preloadCounter.textContent = `${loadedCount} / ${medias.length}`;
                            preloadProgress.style.width = `${progress}%`;
                            
                            // Atualiza o texto baseado no progresso
                            if (loadedCount === medias.length) {
                                const cacheInfo = cachedCount > 0 ? ` (${cachedCount} em cache)` : '';
                                preloadText.textContent = `Carregamento conclu√≠do!${cacheInfo}`;
                            } else {
                                const statusText = isCached ? ' (cache)' : '';
                                preloadText.textContent = `Carregando m√≠dia ${loadedCount + 1}${statusText}...`;
                            }
                            
                            resolve();
                        });
                        
                        videoElement.addEventListener('error', (e) => {
                            console.error(`Erro ao precarregar m√≠dia ${index + 1}:`, midia.url, e);
                            loadedCount++;
                            const progress = (loadedCount / medias.length) * 100;
                            preloadCounter.textContent = `${loadedCount} / ${medias.length}`;
                            preloadProgress.style.width = `${progress}%`;
                            preloadText.textContent = `Erro na m√≠dia ${index + 1}`;
                            reject(e);
                        });
                        
                        videoElement.src = midia.url;
                    });
                });
                
                try {
                    await Promise.all(preloadPromises);
                    console.log('Todas as m√≠dias foram precarregadas com sucesso!');
                    
                    // Esconde o indicador ap√≥s um breve delay
                    setTimeout(() => {
                        preloadIndicator.style.display = 'none';
                    }, 1000);
                    
                    isPreloading = false;
                    return true;
                } catch (error) {
                    console.error('Erro durante o preload:', error);
                    
                    // Esconde o indicador mesmo com erro
                    setTimeout(() => {
                        preloadIndicator.style.display = 'none';
                    }, 2000);
                    
                    isPreloading = false;
                    return false;
                }
            }
            
            // Fun√ß√£o para inicializar o v√≠deo com playlist
            async function inicializarVideo(medias) {
                if (medias && medias.length > 0) {
                    playlist = medias;
                    currentMediaIndex = 0;
                    
                    console.log('Playlist carregada:', playlist);
                    
                    // Precarrega todas as m√≠dias antes de iniciar
                    const preloadSuccess = await preloadMedias(playlist);
                    
                    if (!preloadSuccess) {
                        console.log('Falha no preload, iniciando reprodu√ß√£o normal...');
                    }
                    
                    // For√ßa o play em dispositivos m√≥veis
                    function playVideo() {
                        if (video && video.paused) {
                            video.play().catch(function(error) {
                                console.log('Erro ao reproduzir v√≠deo:', error);
                            });
                        }
                    }
                    
                    // Eventos para dispositivos m√≥veis
                    document.addEventListener('touchstart', playVideo, { once: true });
                    document.addEventListener('click', playVideo, { once: true });
                    
                    // Configura eventos 'ended' para ambos os v√≠deos
                    const mainVideo = document.getElementById('mainVideo');
                    const bufferVideo = document.getElementById('bufferVideo');
                    
                    function onVideoEnded() {
                        console.log('V√≠deo terminou, fazendo transi√ß√£o instant√¢nea...');
                        proximaMidia();
                    }
                    
                    mainVideo.addEventListener('ended', onVideoEnded);
                     bufferVideo.addEventListener('ended', onVideoEnded);
                    
                    // Previne zoom em dispositivos m√≥veis
                    document.addEventListener('touchmove', function(e) {
                        if (e.scale !== 1) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                    
                    // Mant√©m a tela ativa
                    if ('wakeLock' in navigator) {
                        navigator.wakeLock.request('screen').catch(err => {
                            console.log('Wake Lock n√£o suportado:', err);
                        });
                    }
                    
                    // Carrega a primeira m√≠dia da playlist
                    carregarMidia(currentMediaIndex);
                } else {
                    console.log('Nenhuma m√≠dia encontrada');
                    return;
                }
            }
            
            let isMainVideoActive = true; // Controla qual v√≠deo est√° ativo
            
            // Fun√ß√£o para carregar uma m√≠dia espec√≠fica com duplo buffer
            function carregarMidia(index) {
                if (playlist && playlist[index]) {
                    const midia = playlist[index];
                    const mainVideo = document.getElementById('mainVideo');
                    const bufferVideo = document.getElementById('bufferVideo');
                    const activeVideo = isMainVideoActive ? mainVideo : bufferVideo;
                    const nextVideo = isMainVideoActive ? bufferVideo : mainVideo;
                    
                    console.log(`Carregando m√≠dia ${index + 1}/${playlist.length}:`, midia.url);
                    
                    // Verifica se a m√≠dia foi precarregada
                    if (preloadedMedias[index] && preloadedMedias[index].element) {
                        console.log('Usando m√≠dia precarregada:', midia.url);
                        
                        // Copia o conte√∫do da m√≠dia precarregada para o v√≠deo ativo
                        const preloadedVideo = preloadedMedias[index].element;
                        
                        // Transi√ß√£o mais r√°pida - define src e reproduz imediatamente
                        activeVideo.src = preloadedVideo.src;
                        activeVideo.currentTime = 0;
                        
                        // Remove qualquer poster ou placeholder
                        activeVideo.removeAttribute('poster');
                        
                        // Reprodu√ß√£o imediata para m√≠dia precarregada
                        const playPromise = activeVideo.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(function(error) {
                                console.log('Erro ao reproduzir v√≠deo precarregado:', error);
                                // Tenta com muted se falhar
                                activeVideo.muted = true;
                                activeVideo.play().catch(console.error);
                            });
                        }
                    } else {
                        console.log('Carregando m√≠dia normalmente (n√£o precarregada):', midia.url);
                        
                        // Remove qualquer poster ou placeholder
                        activeVideo.removeAttribute('poster');
                        
                        // Determina a URL da m√≠dia (pode ser cacheada ou original)
                        let mediaUrl = midia.url;
                        
                        // Se a m√≠dia tem dados cacheados (base64), usa eles
                        if (midia.cached && midia.url.startsWith('data:')) {
                            console.log('Usando m√≠dia cacheada (base64)');
                            mediaUrl = midia.url;
                        } else if (midia.originalUrl) {
                            // Usa a URL original se dispon√≠vel
                            mediaUrl = midia.originalUrl;
                        }
                        
                        activeVideo.src = mediaUrl;
                        activeVideo.load();
                        
                        // Reprodu√ß√£o com tratamento de erro melhorado
                        const playWhenReady = function() {
                            const playPromise = activeVideo.play();
                            if (playPromise !== undefined) {
                                playPromise.catch(function(error) {
                                    console.log('Erro ao reproduzir v√≠deo:', error);
                                    // Tenta com muted se falhar
                                    activeVideo.muted = true;
                                    activeVideo.play().catch(function(mutedError) {
                                        console.error('Falha total ao reproduzir v√≠deo:', mutedError);
                                        // Se falhar completamente, pula para pr√≥xima m√≠dia
                                        setTimeout(() => proximaMidia(), 1000);
                                    });
                                });
                            }
                        };
                        
                        // Tenta reproduzir quando estiver pronto
                        activeVideo.addEventListener('canplay', playWhenReady, { once: true });
                        
                        // Fallback: se n√£o carregar em 10 segundos, pula para pr√≥xima
                        const timeoutId = setTimeout(() => {
                            console.log('Timeout ao carregar m√≠dia, pulando para pr√≥xima...');
                            proximaMidia();
                        }, 10000);
                        
                        // Cancela o timeout se o v√≠deo carregar
                        activeVideo.addEventListener('loadeddata', () => {
                            clearTimeout(timeoutId);
                        }, { once: true });
                    }
                    
                    // Pr√©-carrega a pr√≥xima m√≠dia no buffer
                    preloadNextMedia(nextVideo, index);
                }
            }
            
            // Fun√ß√£o para pr√©-carregar a pr√≥xima m√≠dia no v√≠deo buffer
            function preloadNextMedia(bufferVideo, currentIndex) {
                const nextIndex = (currentIndex + 1) % playlist.length;
                const nextMidia = playlist[nextIndex];
                
                if (nextMidia && !preloadedMedias[nextIndex]) {
                    console.log('Pr√©-carregando pr√≥xima m√≠dia no buffer:', nextMidia.url);
                    bufferVideo.src = nextMidia.url;
                    bufferVideo.load();
                }
            }
            
            // Fun√ß√£o para transi√ß√£o instant√¢nea entre v√≠deos
             function transicaoInstantanea() {
                 const mainVideo = document.getElementById('mainVideo');
                 const bufferVideo = document.getElementById('bufferVideo');
                 
                 console.log('Iniciando transi√ß√£o instant√¢nea. Video ativo:', isMainVideoActive ? 'main' : 'buffer');
                 
                 if (isMainVideoActive) {
                     // Troca para o buffer video
                     console.log('Trocando para buffer video');
                     
                     // Pausa o v√≠deo atual imediatamente
                     mainVideo.pause();
                     
                     // Transi√ß√£o instant√¢nea - sem delay
                     mainVideo.style.opacity = '0';
                     bufferVideo.style.opacity = '1';
                     
                     // Reproduz o buffer video imediatamente se estiver pronto
                     if (bufferVideo.readyState >= 2) { // HAVE_CURRENT_DATA ou melhor
                         bufferVideo.currentTime = 0;
                         bufferVideo.play().catch(error => {
                             console.log('Erro ao reproduzir buffer video:', error);
                             bufferVideo.muted = true;
                             bufferVideo.play().catch(console.error);
                         });
                     } else {
                         // Se n√£o estiver pronto, for√ßa o carregamento
                         bufferVideo.load();
                         bufferVideo.addEventListener('canplay', function() {
                             bufferVideo.currentTime = 0;
                             bufferVideo.play().catch(console.error);
                         }, { once: true });
                     }
                 } else {
                     // Troca para o main video
                     console.log('Trocando para main video');
                     
                     // Pausa o v√≠deo atual imediatamente
                     bufferVideo.pause();
                     
                     // Transi√ß√£o instant√¢nea - sem delay
                     bufferVideo.style.opacity = '0';
                     mainVideo.style.opacity = '1';
                     
                     // Reproduz o main video imediatamente se estiver pronto
                     if (mainVideo.readyState >= 2) { // HAVE_CURRENT_DATA ou melhor
                         mainVideo.currentTime = 0;
                         mainVideo.play().catch(error => {
                             console.log('Erro ao reproduzir main video:', error);
                             mainVideo.muted = true;
                             mainVideo.play().catch(console.error);
                         });
                     } else {
                         // Se n√£o estiver pronto, for√ßa o carregamento
                         mainVideo.load();
                         mainVideo.addEventListener('canplay', function() {
                             mainVideo.currentTime = 0;
                             mainVideo.play().catch(console.error);
                         }, { once: true });
                     }
                 }
                 
                 // Alterna o v√≠deo ativo
                 isMainVideoActive = !isMainVideoActive;
                 console.log('Transi√ß√£o conclu√≠da. Novo v√≠deo ativo:', isMainVideoActive ? 'main' : 'buffer');
             }
            
            // Fun√ß√£o para avan√ßar para pr√≥xima m√≠dia
            function proximaMidia() {
                console.log('proximaMidia chamada. √çndice atual:', currentMediaIndex);
                currentMediaIndex++;
                console.log('Novo √≠ndice:', currentMediaIndex, 'Total de m√≠dias:', playlist.length);
                if (currentMediaIndex >= playlist.length) {
                    currentMediaIndex = 0; // Volta para o in√≠cio da playlist
                    console.log('Voltando para o in√≠cio da playlist. √çndice resetado para:', currentMediaIndex);
                }
                console.log('Carregando m√≠dia no √≠ndice:', currentMediaIndex);
                
                // Usa transi√ß√£o instant√¢nea se a pr√≥xima m√≠dia j√° est√° no buffer
                 const nextVideo = isMainVideoActive ? document.getElementById('bufferVideo') : document.getElementById('mainVideo');
                 if (nextVideo.src && nextVideo.readyState >= 3) {
                     console.log('Usando transi√ß√£o instant√¢nea');
                     transicaoInstantanea();
                     // Pr√©-carrega a pr√≥xima m√≠dia no v√≠deo que ficou inativo
                     const inactiveVideo = isMainVideoActive ? document.getElementById('bufferVideo') : document.getElementById('mainVideo');
                     preloadNextMedia(inactiveVideo, currentMediaIndex);
                 } else {
                     console.log('Carregando m√≠dia normalmente');
                     carregarMidia(currentMediaIndex);
                 }
            }
            
            // Inicializa o display
            inicializarDisplay();
            
            // Fun√ß√£o para limpar cache antigo (mais de 7 dias)
            function limparCacheAntigo() {
                try {
                    const deviceKey = localStorage.getItem('deviceKey');
                    if (!deviceKey) return;
                    
                    const timestamp = localStorage.getItem(`device_${deviceKey}_timestamp`);
                    if (timestamp) {
                        const cacheDate = new Date(parseInt(timestamp));
                        const now = new Date();
                        const diffDays = Math.floor((now - cacheDate) / (1000 * 60 * 60 * 24));
                        
                        // Se os dados t√™m mais de 7 dias, limpa o cache
                        if (diffDays > 7) {
                            console.log('Limpando cache antigo...');
                            limparTodoCache();
                            console.log('Cache antigo removido.');
                        }
                    }
                    
                    // Limpa tamb√©m caches √≥rf√£os (sem deviceKey correspondente)
                    limparCachesOrfaos();
                } catch (error) {
                    console.error('Erro ao limpar cache antigo:', error);
                }
            }
            
            // Fun√ß√£o para limpar caches √≥rf√£os
            function limparCachesOrfaos() {
                try {
                    const deviceKey = localStorage.getItem('deviceKey');
                    const keysToRemove = [];
                    
                    for (let key in localStorage) {
                        // Remove caches de dispositivos diferentes do atual
                        if ((key.startsWith('device_') || key.startsWith('media_')) && 
                            !key.includes(deviceKey)) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    if (keysToRemove.length > 0) {
                        console.log(`Removidos ${keysToRemove.length} caches √≥rf√£os.`);
                    }
                } catch (error) {
                    console.error('Erro ao limpar caches √≥rf√£os:', error);
                }
            }
            
            // Fun√ß√£o para limpar todo o cache do dispositivo atual
            function limparTodoCache() {
                try {
                    const deviceKey = localStorage.getItem('deviceKey');
                    if (!deviceKey) return;
                    
                    const keysToRemove = [];
                    
                    // Coleta todas as chaves relacionadas ao dispositivo
                    for (let key in localStorage) {
                        if (key.startsWith(`device_${deviceKey}_`) || 
                            key.startsWith(`media_${deviceKey}_`)) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    // Remove as chaves
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    console.log(`Cache limpo: ${keysToRemove.length} itens removidos.`);
                    return keysToRemove.length;
                } catch (error) {
                    console.error('Erro ao limpar cache:', error);
                    return 0;
                }
            }
            
            // Verifica a chave a cada 30 segundos com suporte offline melhorado
             setInterval(async function() {
                 const deviceKey = localStorage.getItem('deviceKey');
                 if (deviceKey) {
                     try {
                         // Tenta verificar online primeiro
                         const response = await fetch(`http://192.168.0.120:4000/public/device/${deviceKey}`, {
                             timeout: 5000 // Timeout de 5 segundos
                         });
                         
                         if (response.ok) {
                             const dadosDispositivo = await response.json();
                             
                             // Remove indicador offline se existir
                             const offlineIndicator = document.getElementById('offlineIndicator');
                             if (offlineIndicator) {
                                 offlineIndicator.remove();
                             }
                             
                             // Salva dados atualizados no cache
                             await salvarDadosCache(deviceKey, dadosDispositivo);
                             
                             if (dadosDispositivo && showPlay.style.display === 'none') {
                                 // Chave foi validada - inicializa o player
                                 showKey.style.display = 'none';
                                 showPlay.style.display = 'block';
                                 
                                 // Configura o layout baseado no showClienteInfo do dispositivo
                                 configurarLayout(dadosDispositivo.device.showClienteInfo, dadosDispositivo);
                                 
                                 inicializarVideo(dadosDispositivo.panel.medias);
                             } else if (dadosDispositivo && showPlay.style.display === 'block') {
                                 // Configura o layout (pode ter mudado no painel administrativo)
                                 configurarLayout(dadosDispositivo.device.showClienteInfo, dadosDispositivo);
                                 
                                 // Verifica se a playlist mudou APENAS se n√£o estiver reproduzindo
                                 const mainVideo = document.getElementById('mainVideo');
                                 const bufferVideo = document.getElementById('bufferVideo');
                                 const isPlaying = (mainVideo && !mainVideo.paused) || (bufferVideo && !bufferVideo.paused);
                                 
                                 if (JSON.stringify(playlist) !== JSON.stringify(dadosDispositivo.panel.medias)) {
                                     if (!isPlaying) {
                                         console.log('Playlist atualizada, recarregando m√≠dias...');
                                         inicializarVideo(dadosDispositivo.panel.medias);
                                     } else {
                                         console.log('Playlist atualizada, mas v√≠deo est√° reproduzindo. Aguardando pr√≥xima verifica√ß√£o.');
                                     }
                                 }
                             }
                         } else {
                             console.log('API indispon√≠vel, continuando em modo offline');
                             adicionarIndicadorOffline();
                             
                             // Se o player n√£o estiver vis√≠vel, tenta carregar do cache
                             if (showPlay.style.display === 'none') {
                                 const dadosCache = await carregarDadosCache(deviceKey);
                                 if (dadosCache && dadosCache.panel && dadosCache.panel.medias && dadosCache.panel.medias.length > 0) {
                                     console.log('Carregando dados do cache em modo offline');
                                     showKey.style.display = 'none';
                                     showPlay.style.display = 'block';
                                     configurarLayout(dadosCache.device.showClienteInfo, dadosCache);
                                     inicializarVideo(dadosCache.panel.medias);
                                 }
                             }
                         }
                     } catch (error) {
                         console.log('Erro de conex√£o, continuando em modo offline:', error);
                         adicionarIndicadorOffline();
                         
                         // Se o player n√£o estiver vis√≠vel, tenta carregar do cache
                         if (showPlay.style.display === 'none') {
                             const dadosCache = await carregarDadosCache(deviceKey);
                             if (dadosCache && dadosCache.panel && dadosCache.panel.medias && dadosCache.panel.medias.length > 0) {
                                 console.log('Carregando dados do cache ap√≥s erro de conex√£o');
                                 showKey.style.display = 'none';
                                 showPlay.style.display = 'block';
                                 configurarLayout(dadosCache.device.showClienteInfo, dadosCache);
                                 inicializarVideo(dadosCache.panel.medias);
                             }
                         }
                     }
                 }
                 
                 // Limpa cache antigo a cada verifica√ß√£o
                 limparCacheAntigo();
             }, 30000);
             
             // Limpa cache antigo na inicializa√ß√£o
             limparCacheAntigo();
        });
    </script>
</body>

</html>