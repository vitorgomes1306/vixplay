<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vix Mídia - Dispositivos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/config.js"></script> 
    <!-- Custom CSS -->
    <link rel="stylesheet" href="modern-dashboard.css">
    <style>
        /* Estilos adicionais para indicadores de status */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-indicator.online {
            background-color: var(--success-color);
            box-shadow: 0 0 5px var(--success-color);
        }
        .status-indicator.offline {
            background-color: var(--danger-color);
            box-shadow: 0 0 5px var(--danger-color);
        }
    </style>
</head>

<body>
  <!-- Overlay para sidebar em dispositivos móveis -->
  <div class="sidebar-overlay"></div>

  <div class="wrapper">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="../img/vixmidia_dark.png" alt="Logo VixMídia" class="img-fluid">
        <button class="sidebar-toggle">
          <i class="bi bi-chevron-left"></i>
        </button>
      </div>

      <ul class="list-unstyled">
        <li>
          <a class="sidebar-link" href="index.html">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link active" href="dispositivos.html">
            <i class="bi bi-tv"></i>
            <span>Dispositivos</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="panels.html">
            <i class="bi bi-pip-fill"></i>
            <span>Painéis</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="midias.html">
            <i class="bi bi-collection-play"></i>
            <span>Mídias</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="clients.html">
            <i class="bi bi-person-video2"></i>
            <span>Clientes</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="relatorios.html">
            <i class="bi bi-clipboard2-pulse"></i>
            <span>Relatórios</span>
          </a>
        </li>
      </ul>

      <hr>

      <ul class="list-unstyled">
        <li>
          <a class="sidebar-link" href="configuracoes.html">
            <i class="bi bi-gear"></i>
            <span>Configurações</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="#" id="logoutBtnSidebar">
            <i class="bi bi-box-arrow-right"></i>
            <span>Sair</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="d-flex align-items-center">
          <div class="sidebar-user-icon">
            <i class="bi bi-person-circle"></i>
          </div>
          <div class="sidebar-user-info">
            <span id="userName">Usuário</span>
          </div>
        </div>
        <div class="theme-toggle">
          <i class="bi bi-sun-fill"></i>
          <div class="form-check form-switch d-inline-block ms-1 me-1">
            <input class="form-check-input" type="checkbox" id="themeSwitch">
            <label class="form-check-label" for="themeSwitch"></label>
          </div>
          <i class="bi bi-moon-fill"></i>
        </div>
      </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="content">
      <!-- Cabeçalho da Página -->
      <div class="page-header">
        <div>
          <h1 class="page-title"><i class="bi bi-tv"></i> Meus Dispositivos</h1>
          <p class="page-subtitle">Gerencie seus dispositivos de exibição</p>
        </div>
        <div class="page-actions">
          <div class="d-flex gap-2 align-items-center">
            <div class="search-container">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Buscar dispositivos..." id="searchDevice">
              </div>
            </div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
              <i class="bi bi-plus-circle"></i> Novo Dispositivo
            </button>
            <!-- Ícone de configuração -->
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#configModal" title="Configurações">
              <i class="bi bi-gear"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Alertas -->
      <div id="alertContainer" class="mb-4"></div>

      <!-- Indicador de carregamento -->
      <div id="loadingIndicator" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 text-muted">Carregando dispositivos...</p>
      </div>

      <!-- Card de Estatísticas -->
      <div id="statsContainer" class="mb-4" style="display: none;">
        <div class="col-3 card stats-card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-grid-3x3-gap me-2 fs-4"></i>
                  <h5 class="card-title mb-1 text-white">
                    Total de Dispositivos
                  </h5>
                </div>
                <h2 class="mb-1" id="totalDispositivos">0</h2>
                <small class="text-white-50">dispositivos cadastrados</small>
              </div>
              <div class="stats-icon">
                <i class="bi bi-bar-chart fs-1 text-white-50"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensagem quando não há dispositivos -->
      <div id="noDevices" class="text-center py-5" style="display: none;">
        <div class="mb-4">
          <i class="bi bi-tv display-1 text-muted"></i>
        </div>
        <h4 class="text-muted mb-3">Nenhum dispositivo encontrado</h4>
        <p class="text-muted mb-4">Comece criando seu primeiro dispositivo para gerenciar suas telas de exibição.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
          <i class="bi bi-plus-circle me-2"></i>Criar Primeiro Dispositivo
        </button>
      </div>

      <!-- Container dos Dispositivos -->
      <div class="row" id="dispositivosContainer">
        </div>
      </div>

      <!-- Botão flutuante para dispositivos móveis -->
      <button class="mobile-toggle d-lg-none">
        <i class="bi bi-list"></i>
      </button>
    </main>
  </div>

    <!-- Modal: Adicionar Dispositivo -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form id="formAddDevice" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Coluna Esquerda: Campos Principais -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceName" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="deviceName" required>
                            </div>
                            <!-- Campos da Chave do Dispositivo (6 caixas) -->
                            <div class="mb-3">
                                <label class="form-label">Chave do Dispositivo (6 dígitos)</label>
                                <div id="deviceKeyContainer" class="d-flex justify-content-between align-items-center">
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="0" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="1" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="2" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="3" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="4" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="5" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="deviceFormat" class="form-label">Formato</label>
                                <select class="form-select" id="deviceFormat" required>
                                    <option value="HORIZONTAL">Horizontal</option>
                                    <option value="VERTICAL">Vertical</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="devicePanelId" class="form-label">Painel</label>
                                <select class="form-select" id="devicePanelId" required>
                                    <option value="">Carregando painéis...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="deviceType" class="form-label">Tipo</label>
                                <select class="form-select" id="deviceType" required>
                                    <option value="TV">TV</option>
                                    <option value="MONITOR">Monitor</option>
                                    <option value="TABLET">Tablet</option>
                                    <option value="TOTEM">Totem</option>
                                    <option value="LED_PANEL">Painel de LED</option>
                                    <option value="PROJECTOR">Projetor</option>
                                    <option value="PC">PC</option>
                                </select>
                            </div>
                        </div>
                        <!-- Coluna Direita: Geo Localização -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceGeoLocation" class="form-label">Geo Localização (Opcional)</label>
                                <input type="text" class="form-control" id="deviceGeoLocation"
                                    placeholder="Ex: -23.550520, -46.633308">
                                <small class="form-text text-muted">Coordenadas de latitude e longitude.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Dispositivo -->
    <div class="modal fade" id="editDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form id="formEditDevice" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editDeviceId">
                    <div class="row">
                        <!-- Coluna Esquerda: Campos Principais -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDeviceName" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="editDeviceName" required>
                            </div>
                            <!-- Campos da Chave do Dispositivo (6 caixas) para Edição -->
                            <div class="mb-3">
                                <label class="form-label">Chave do Dispositivo (6 dígitos, maiúsculas)</label>
                                <div id="editDeviceKeyContainer"
                                    class="d-flex justify-content-between align-items-center">
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="0" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="1" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="2" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="3" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="4" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="5" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceFormat" class="form-label">Formato</label>
                                <select class="form-select" id="editDeviceFormat" required>
                                    <option value="HORIZONTAL">Horizontal</option>
                                    <option value="VERTICAL">Vertical</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDevicePanelId" class="form-label">Painel</label>
                                <select class="form-select" id="editDevicePanelId" required>
                                    <option value="">Carregando painéis...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceType" class="form-label">Tipo</label>
                                <select class="form-select" id="editDeviceType" required>
                                    <option value="TV">TV</option>
                                    <option value="MONITOR">Monitor</option>
                                    <option value="TABLET">Tablet</option>
                                    <option value="TOTEM">Totem</option>
                                    <option value="LED_PANEL">Painel de LED</option>
                                    <option value="PROJECTOR">Projetor</option>
                                    <option value="PC">PC</option>
                                </select>
                            </div>
                        </div>
                        <!-- Coluna Direita: Geo Localização para Edição -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDeviceGeoLocation" class="form-label">Geo Localização
                                    (Opcional)</label>
                                <input type="text" class="form-control" id="editDeviceGeoLocation"
                                    placeholder="Ex: -23.550520, -46.633308">
                                <small class="form-text text-muted">Coordenadas de latitude e longitude.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script do Bootstrap (deve ser o último antes do seu script personalizado) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script personalizado da dashboard -->
    <script src="modern-dashboard.js"></script>
    <script>
        // ===== VARIÁVEIS GLOBAIS =====
        const token = localStorage.getItem('token');
        const userName = localStorage.getItem('userName');
        const alertContainer = document.getElementById('alertContainer');

        // ===== VERIFICAÇÃO DE AUTENTICAÇÃO =====
        if (!token) {
            window.location.href = "login.html";
        }
        
        // Função para mostrar alertas Bootstrap
        function mostrarAlerta(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-danger';
            const icon = type === 'success' ? 'bi-check-circle' : 
                        type === 'warning' ? 'bi-exclamation-triangle' : 'bi-exclamation-triangle';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi ${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            alertContainer.innerHTML = alertHtml;

            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        // Alias para compatibilidade com código existente
        const showAlert = mostrarAlerta;

        // Função para carregar e exibir dispositivos
        async function carregarDispositivos() {
            const container = document.getElementById('dispositivosContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const statsContainer = document.getElementById('statsContainer');
            const noDevices = document.getElementById('noDevices');
            
            // Mostrar indicador de carregamento
            loadingIndicator.style.display = 'block';
            statsContainer.style.display = 'none';
            noDevices.style.display = 'none';
            container.innerHTML = '';
            document.getElementById('totalDispositivos').textContent = '0';

            try {
                const resposta = await fetch(`${APP_CONFIG.API_BASE_URL}${APP_CONFIG.API_ENDPOINTS.DEVICES}`, {
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('token')
                    }
                });

                if (!resposta.ok) {
                    const errorData = await resposta.json();
                    throw new Error(errorData.message || 'Erro ao carregar dispositivos');
                }

                const dispositivos = await resposta.json();
                
                // Esconder indicador de carregamento
                loadingIndicator.style.display = 'none';

                if (!Array.isArray(dispositivos) || dispositivos.length === 0) {
                    noDevices.style.display = 'block';
                    statsContainer.style.display = 'none';
                    document.getElementById('totalDispositivos').textContent = '0';
                    return;
                }

                const formatarData = (data) => {
                    if (!data) return '-';
                    const d = new Date(data);
                    return d.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                };

                container.innerHTML = dispositivos.map(device => {
                    const statusDeviceBadge = device.statusDevice
                        ? '<span class="badge bg-success">Online</span>'
                        : '<span class="badge bg-danger">Offline</span>';
                    const ativoInativoBadge = device.status === 'Ativo'
                        ? '<span class="badge bg-primary">Ativo</span>'
                        : '<span class="badge bg-secondary">Inativo</span>';

                    return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 shadow-sm card-hover">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h5>${device.name}</h5>
                                    <div>${ativoInativoBadge} ${statusDeviceBadge}</div>
                                </div>
                                <p><small class="text-muted">Criado: ${formatarData(device.createdAt)}</small></p>
                                <p><small class="text-muted">Tipo: ${device.type}</small></p>
                                <p><small class="text-muted">Formato: ${device.format}</small></p>
                                <p><small class="text-muted">Painel: ${device.panel?.name || 'N/A'}</small></p>
                                
                                
                                <p><small class="text-muted">Chave: <code>${device.deviceKey}</code></small></p>
                                ${device.geoLocation ? `<p><small class="text-muted">Localização: ${device.geoLocation}</small></p>` : ''}
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editarDispositivo(${device.id})">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="excluirDispositivo(${device.id}, '${device.name}')">
                                        <i class="bi bi-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // Mostrar card de estatísticas e atualizar contador
                statsContainer.style.display = 'block';
                noDevices.style.display = 'none';
                document.getElementById('totalDispositivos').textContent = dispositivos.length;

            } catch (err) {
                loadingIndicator.style.display = 'none';
                container.innerHTML = `<div class="col-12"><div class="alert alert-danger">Erro: ${err.message}</div></div>`;
                statsContainer.style.display = 'none';
                noDevices.style.display = 'none';
                showAlert(`Erro ao carregar dispositivos: ${err.message}`, 'danger');
            }
        }

        // Função para carregar painéis para o dropdown (agora reutilizável)
        // O parâmetro `targetSelectId` permite especificar qual select HTML será populado
        async function carregarPaineis(targetSelectId = 'devicePanelId', selectedPanelId = null) {
            try {
                // CORREÇÃO: Endpoint para buscar painéis do usuário logado (sem /public)
                const res = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.PANELS), {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || `Erro ao carregar painéis: Status ${res.status}`);
                }
                const paineis = await res.json();
                const selectPanel = document.getElementById(targetSelectId);
                selectPanel.innerHTML = ''; // Limpa opções existentes

                if (paineis.length === 0) {
                    selectPanel.innerHTML = '<option value="">Nenhum painel disponível</option>';
                    selectPanel.disabled = true;
                    showAlert('Nenhum painel encontrado para este usuário. Por favor, cadastre um painel primeiro.', 'warning');
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Selecione um painel...";
                    defaultOption.disabled = true;
                    defaultOption.selected = true; // Define como selecionada por padrão
                    selectPanel.appendChild(defaultOption);

                    paineis.forEach(panel => {
                        const option = document.createElement('option');
                        option.value = panel.id;
                        option.textContent = panel.name;
                        if (selectedPanelId !== null && panel.id === selectedPanelId) {
                            option.selected = true; // Pré-seleciona o painel do dispositivo
                            defaultOption.selected = false; // Deseleciona a opção padrão
                        }
                        selectPanel.appendChild(option);
                    });
                    selectPanel.disabled = false;
                }
            } catch (err) {
                console.error('Erro ao carregar painéis:', err.message);
                const selectPanel = document.getElementById(targetSelectId);
                selectPanel.innerHTML = '<option value="">Erro ao carregar painéis</option>';
                selectPanel.disabled = true;
                showAlert(`Erro ao carregar painéis: ${err.message}`, 'danger');
            }
        }

        // Função genérica para inicializar inputs da chave do dispositivo (add e edit)
        function initializeDeviceKeyInputs(containerId) {
            const keyInputs = document.querySelectorAll(`#${containerId} .device-key-input`);

            keyInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.toUpperCase(); // Converte para maiúsculas imediatamente
                    e.target.value = value; // Atualiza o campo de input

                    if (value.length === 1) { // Se um caractere foi inserido
                        if (index < keyInputs.length - 1) {
                            keyInputs[index + 1].focus(); // Move o foco para o próximo input
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '') {
                        if (index > 0) {
                            keyInputs[index - 1].focus(); // Move o foco para o input anterior
                            e.preventDefault(); // Previne o comportamento padrão do backspace no input vazio atual
                        }
                    } else if (e.key.length === 1 && !/[a-zA-Z0-9]/.test(e.key)) {
                        // Previne a entrada de caracteres não alfanuméricos
                        e.preventDefault();
                    }
                });

                // Adiciona listener para garantir que o paste também converta para maiúsculas e distribua
                input.addEventListener('paste', (e) => {
                    e.preventDefault(); // Previne o paste padrão
                    const pasteData = e.clipboardData.getData('Text').toUpperCase();
                    let currentInputIndex = index;
                    for (let i = 0; i < pasteData.length && currentInputIndex < keyInputs.length; i++) {
                        keyInputs[currentInputIndex].value = pasteData[i];
                        currentInputIndex++;
                    }
                    // Foca no último input preenchido ou no último da sequência
                    if (currentInputIndex < keyInputs.length) {
                        keyInputs[currentInputIndex].focus();
                    } else {
                        keyInputs[keyInputs.length - 1].focus();
                    }
                });
            });
        }


        // Função para abrir modal de edição e preencher dados
        async function editarDispositivo(id) {
            try {
                // Endpoint CORRIGIDO: usa /device para buscar um dispositivo específico
                const res = await fetch(buildApiUrl(`${APP_CONFIG.API_ENDPOINTS.DEVICE}/${id}`), {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao buscar dispositivo para edição');
                }

                const device = await res.json();

                // Preencher campos do modal de edição
                document.getElementById('editDeviceId').value = device.id;
                document.getElementById('editDeviceName').value = device.name;
                document.getElementById('editDeviceFormat').value = device.format;
                document.getElementById('editDeviceType').value = device.type;
                document.getElementById('editDeviceGeoLocation').value = device.geoLocation || ''; // Preenche ou vazio

                // Preencher os inputs da chave do dispositivo
                const editKeyInputs = document.querySelectorAll('#editDeviceKeyContainer .device-key-input');
                if (device.deviceKey) {
                    device.deviceKey.split('').forEach((char, index) => {
                        if (editKeyInputs[index]) {
                            editKeyInputs[index].value = char;
                        }
                    });
                } else {
                    editKeyInputs.forEach(input => input.value = ''); // Limpa se não houver chave
                }

                // Carregar e pré-selecionar o painel
                await carregarPaineis('editDevicePanelId', device.panelId);


                // Abrir o modal
                new bootstrap.Modal(document.getElementById('editDeviceModal')).show();

                // Inicializar a lógica dos inputs da chave para o modal de edição
                initializeDeviceKeyInputs('editDeviceKeyContainer');
                // Opcional: foca no primeiro input da chave do modal de edição
                document.querySelector('#editDeviceKeyContainer .device-key-input')?.focus();

            } catch (err) {
                showAlert(`Erro ao carregar dispositivo para edição: ${err.message}`, 'danger');
            }
        }

        // Função para excluir dispositivo
        async function excluirDispositivo(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o dispositivo "${nome}"?`)) return;

            try {
                // CORRIGIDO: usa DEVICE (singular) para excluir um dispositivo específico
                const res = await fetch(buildApiUrl(`${APP_CONFIG.API_ENDPOINTS.DEVICE}/${id}`), {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao excluir dispositivo');
                }
                showAlert('Dispositivo excluído com sucesso!', 'success');
                carregarDispositivos();
            } catch (err) {
                showAlert(`Erro ao excluir dispositivo: ${err.message}`, 'danger');
            }
        }

        // Event Listener para adicionar dispositivo
        document.getElementById('formAddDevice').addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('deviceName').value;

            // Coleta a chave do dispositivo dos 6 inputs e concatena
            const keyInputs = document.querySelectorAll('#deviceKeyContainer .device-key-input');
            const deviceKey = Array.from(keyInputs).map(input => input.value).join('').toUpperCase(); // Garante maiúsculas

            const format = document.getElementById('deviceFormat').value;
            const panelId = parseInt(document.getElementById('devicePanelId').value);
            const type = document.getElementById('deviceType').value;
            const geoLocation = document.getElementById('deviceGeoLocation').value.trim();

            // Validações básicas
            if (isNaN(panelId)) {
                showAlert('Por favor, selecione um painel válido.', 'danger');
                return;
            }
            if (!/^[A-Z0-9]{6}$/.test(deviceKey)) {
                showAlert('A Chave do Dispositivo deve ter 6 dígitos alfanuméricos maiúsculos (Ex: A1B2C3).', 'danger');
                return;
            }

            const deviceData = {
                name,
                deviceKey,
                format,
                panelId,
                type,
            };
            if (geoLocation) {
                deviceData.geoLocation = geoLocation;
            }

            try {
                // CORRIGIDO: usa DEVICE (singular) para criar um novo dispositivo
                const res = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.DEVICE), {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(deviceData)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao adicionar dispositivo');
                }

                bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
                showAlert('Dispositivo adicionado com sucesso!', 'success');
                document.getElementById('formAddDevice').reset(); // Limpa os campos do formulário
                keyInputs.forEach(input => input.value = ''); // Limpa explicitamente os inputs da chave
                carregarDispositivos(); // Recarrega a lista de dispositivos
            } catch (err) {
                showAlert(`Erro ao adicionar dispositivo: ${err.message}`, 'danger');
            }
        });

        // Event Listener para editar dispositivo
        document.getElementById('formEditDevice').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('editDeviceId').value;
            const name = document.getElementById('editDeviceName').value;

            // Coleta a chave do dispositivo dos 6 inputs de edição e concatena
            const editKeyInputs = document.querySelectorAll('#editDeviceKeyContainer .device-key-input');
            const deviceKey = Array.from(editKeyInputs).map(input => input.value).join('').toUpperCase();

            const format = document.getElementById('editDeviceFormat').value;
            const panelId = parseInt(document.getElementById('editDevicePanelId').value);
            const type = document.getElementById('editDeviceType').value;
            const geoLocation = document.getElementById('editDeviceGeoLocation').value.trim();

            // Validações básicas para edição
            if (isNaN(panelId)) {
                showAlert('Por favor, selecione um painel válido.', 'danger');
                return;
            }
            if (!/^[A-Z0-9]{6}$/.test(deviceKey)) {
                showAlert('A Chave do Dispositivo deve ter 6 dígitos alfanuméricos maiúsculos (Ex: A1B2C3).', 'danger');
                return;
            }

            const deviceData = {
                name,
                deviceKey,
                format,
                panelId,
                type,
            };
            if (geoLocation) {
                deviceData.geoLocation = geoLocation;
            }

            try {
                // CORRIGIDO: usa DEVICE (singular) para atualizar um dispositivo específico
                const res = await fetch(buildApiUrl(`${APP_CONFIG.API_ENDPOINTS.DEVICE}/${id}`), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(deviceData)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao atualizar dispositivo');
                }
                bootstrap.Modal.getInstance(document.getElementById('editDeviceModal')).hide();
                showAlert('Dispositivo atualizado com sucesso!', 'success');
                carregarDispositivos();
            } catch (err) {
                showAlert(`Erro ao atualizar dispositivo: ${err.message}`, 'danger');
            }
        });

        // Função para lidar com o logout
        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userName');
            window.location.href = 'login.html';
        }

        // Função para definir o link ativo na sidebar
        function setActiveSidebarLink() {
            const currentPage = window.location.pathname.split('/').pop();
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPage) {
                    link.classList.add('active');
                }
            });
        }

        // Função para ir para a página de dispositivos (se for diferente da atual)
        function irParaDispositivos() {
            window.location.href = 'dispositivos.html';
        }


        // Carrega dispositivos e painéis quando a página é carregada
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticação
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Preencher nome do usuário
            if (userName) {
                document.getElementById('userNameDisplay').textContent = userName;
            }

            // Definir link ativo na sidebar
            setActiveSidebarLink();

            // Anexar evento de logout
            document.getElementById('logoutBtnSidebar').addEventListener('click', handleLogout);

            // Inicializar tema escuro se necessário
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }

            // Carregar dados
            carregarDispositivos();
            carregarPaineis(); // Carrega painéis para o modal de adição por padrão
        });

        // Inicializa os inputs da chave do dispositivo quando o modal de ADIÇÃO é aberto
        document.getElementById('addDeviceModal').addEventListener('shown.bs.modal', () => {
            initializeDeviceKeyInputs('deviceKeyContainer');
            document.querySelector('#deviceKeyContainer .device-key-input')?.focus();
        });

        // Limpa os inputs da chave do dispositivo quando o modal de ADIÇÃO é fechado
        document.getElementById('addDeviceModal').addEventListener('hidden.bs.modal', () => {
            const keyInputs = document.querySelectorAll('#deviceKeyContainer .device-key-input');
            keyInputs.forEach(input => input.value = '');
            // Limpar outros campos manualmente se o reset() não pegar todos os inputs dinâmicos
            document.getElementById('formAddDevice').reset();
            // Recarregar paineis para garantir que o estado inicial esteja correto, caso não tenha painel selecionado
            carregarPaineis();
        });
        
        // ===== MODAL DE CONFIGURAÇÃO =====
        // Toggle de tema
        const themeToggle = document.getElementById('themeToggle');
        const themeToggleModal = document.getElementById('themeToggleModal');
        const body = document.body;
        
        // Verificar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          body.classList.add('dark-theme');
          if (themeToggle) themeToggle.checked = true;
          if (themeToggleModal) themeToggleModal.checked = true;
        }
        
        // Função para alternar tema
        function toggleTheme(isDark) {
          if (isDark) {
            body.classList.add('dark-theme');
            localStorage.setItem('theme', 'dark');
          } else {
            body.classList.remove('dark-theme');
            localStorage.setItem('theme', 'light');
          }
          // Sincronizar ambos os toggles
          if (themeToggle) themeToggle.checked = isDark;
          if (themeToggleModal) themeToggleModal.checked = isDark;
        }
        
        if (themeToggle) {
          themeToggle.addEventListener('change', function() {
            toggleTheme(this.checked);
          });
        }
        
        if (themeToggleModal) {
          themeToggleModal.addEventListener('change', function() {
            toggleTheme(this.checked);
          });
        }
        
        // ===== BUSCA EM TEMPO REAL =====
        document.getElementById('searchDevice').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const deviceCards = document.querySelectorAll('#dispositivosContainer .col-md-6');
            let visibleCount = 0;
            
            deviceCards.forEach(card => {
                const deviceName = card.querySelector('h5').textContent.toLowerCase();
                const deviceType = card.querySelector('.text-muted').textContent.toLowerCase();
                const deviceKey = card.querySelector('code').textContent.toLowerCase();
                
                const isVisible = deviceName.includes(searchTerm) || 
                                deviceType.includes(searchTerm) || 
                                deviceKey.includes(searchTerm);
                
                if (isVisible) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Atualizar contador baseado na busca
            if (searchTerm === '') {
                // Se não há termo de busca, mostrar total real
                const totalDevices = deviceCards.length;
                document.getElementById('totalDispositivos').textContent = totalDevices;
            } else {
                // Se há busca, mostrar apenas dispositivos visíveis
                document.getElementById('totalDispositivos').textContent = visibleCount;
            }
        });
        
        // Carregar informações do usuário no modal
        const userNameModal = document.getElementById('userNameModal');
        const userEmailModal = document.getElementById('userEmailModal');
        if (userNameModal) userNameModal.textContent = userName || 'Usuário';
        if (userEmailModal) userEmailModal.textContent = userEmail || 'usuario@email.com';
        
        // Logout do modal
        const logoutBtnModal = document.getElementById('logoutBtnModal');
        if (logoutBtnModal) {
          logoutBtnModal.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja sair?')) {
              localStorage.removeItem('usuarioEmail');
              localStorage.removeItem('usuarioName');
              localStorage.removeItem('token');
              window.location.href = '/';
            }
          });
        }

    </script>

    <!-- Modal de Configuração -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="configModalLabel">
              <i class="bi bi-gear me-2"></i>Configurações
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Informações do usuário -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-person-circle me-2"></i>Usuário Logado
              </h6>
              <div class="d-flex align-items-center p-3 bg-light rounded">
                <div class="me-3">
                  <i class="bi bi-person-circle text-primary" style="font-size: 2rem;"></i>
                </div>
                <div>
                  <div class="fw-semibold" id="userNameModal">Usuário</div>
                  <div class="text-muted small" id="userEmailModal">usuario@email.com</div>
                </div>
              </div>
            </div>
            
            <!-- Configurações de tema -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-palette me-2"></i>Aparência
              </h6>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="themeToggleModal">
                <label class="form-check-label" for="themeToggleModal">
                  <i class="bi bi-moon me-2"></i>Modo Escuro
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle me-1"></i>Fechar
            </button>
            <button type="button" class="btn btn-danger" id="logoutBtnModal">
              <i class="bi bi-box-arrow-right me-1"></i>Sair
            </button>
          </div>
        </div>
      </div>
    </div>
</body>

</html>