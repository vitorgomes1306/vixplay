<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vix Mídia - Dispositivos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/config.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="modern-dashboard.css">
    <style>
        /* Estilos adicionais para indicadores de status */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Estilos para melhorar layout dos modais de geolocalização */
        .geo-modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .geo-tabs .nav-link {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        
        .geo-alert-container {
            min-height: 40px;
            transition: all 0.3s ease;
        }
        
        .leaflet-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .tab-content {
            min-height: 200px;
        }
        
        .geo-card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .geo-tabs .nav-link {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
            }
            
            #createMap, #editMap {
                height: 250px !important;
            }
        }

        .status-indicator.online {
            background-color: var(--success-color);
            box-shadow: 0 0 5px var(--success-color);
        }

        .status-indicator.offline {
            background-color: var(--danger-color);
            box-shadow: 0 0 5px var(--danger-color);
        }

        /* Estilos para o modal do mapa dos dispositivos */
        #devicesMapModal .modal-dialog {
            max-width: 95vw;
        }
        
        #devicesMap {
            border-radius: 8px;
        }
        
        .legend-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .legend-icon.online {
            background-color: #28a745;
        }
        
        .legend-icon.offline {
            background-color: #dc3545;
        }
        
        /* Estilos customizados para marcadores do Leaflet */
        .device-marker-online {
            background-color: #28a745;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .device-marker-offline {
            background-color: #dc3545;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>
   <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay d-lg-none"></div>

  <div class="wrapper">
    <!-- Sidebar -->
    <nav class="sidebar d-none d-lg-block" id="sidebar">
      <div class="sidebar-header">
        <img src="../img/logo.png" alt="Logo VixMídia" class="img-fluid">
        <button class="sidebar-toggle">
          <i class="bi bi-chevron-left"></i>
        </button>
      </div>

      <ul class="list-unstyled">
        <li>
          <a class="sidebar-link" href="index.html">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link active" href="dispositivos.html">
            <i class="bi bi-tv"></i>
            <span>Dispositivos</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="panels.html">
            <i class="bi bi-pip-fill"></i>
            <span>Painéis</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="midias.html">
            <i class="bi bi-collection-play"></i>
            <span>Minhas Mídias</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="midias.html">
            <i class="bi bi-repeat"></i>
            <span>Mídias globais</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="clients.html">
            <i class="bi bi-person-video2"></i>
            <span>Clientes</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="campaigns.html">
            <i class="bi bi-megaphone"></i>
            <span>Campanhas</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="relatorios.html">
            <i class="bi bi-clipboard2-pulse"></i>
            <span>Relatórios</span>
          </a>
        </li>
        <li id="adminMenuItem" style="display: none;">
          <a class="sidebar-link" href="admin.html">
            <i class="bi bi-shield-check"></i>
            <span>Administração</span>
          </a>
        </li>
      </ul>

      <hr>

      <ul class="list-unstyled">
        <li>
          <a class="sidebar-link" href="configuracoes.html">
            <i class="bi bi-gear"></i>
            <span>Configurações</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="#" id="logoutBtnSidebar">
            <i class="bi bi-box-arrow-left"></i>
            <span>Sair</span>
          </a>
        </li>
      </ul>

      <!-- Mobile menu toggle button -->
      <button class="btn btn-primary d-lg-none position-fixed" 
              style="bottom: 20px; right: 20px; z-index: 1030;"
              onclick="document.getElementById('sidebar').classList.toggle('d-none')">
        <i class="bi bi-list"></i>
      </button>

      <!-- Informações do usuário -->
      <div class="sidebar-footer mt-auto">
        <div class="d-flex align-items-center mb-3">
          <div class="sidebar-user-icon me-2">
            <i class="bi bi-person-circle text-white" style="font-size: 1.5rem;"></i>
          </div>
          <div class="sidebar-user-info">
            <span id="userName" class="text-white">Usuário</span>
          </div>
        </div>
        <!-- Toggle de tema claro/escuro -->
        <div class="px-0 py-2">
          <div class="form-check form-switch d-flex align-items-center">
            <input class="form-check-input me-2" type="checkbox" id="themeToggle">
            <label class="form-check-label text-white" for="themeToggle">
              <i class="bi bi-moon"></i>
              <span class="ms-2">Modo Escuro</span>
            </label>
          </div>
        </div>
      </div>
    </nav>

        <!-- Conteúdo Principal -->
        <main class="content">
            <!-- Cabeçalho da Página -->
            <div class="page-header">
                <div>
                    <h1 class="page-title"><i class="bi bi-tv"></i> Meus Dispositivos</h1>
                    <p class="page-subtitle">Gerencie seus dispositivos de exibição</p>
                </div>
                <div class="page-actions">
                    <div class="d-flex gap-2 align-items-center">
                        <div class="search-container">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" placeholder="Buscar dispositivos..."
                                    id="searchDevice">
                            </div>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#devicesMapModal" title="Visualizar dispositivos no mapa">
                            <i class="bi bi-geo-alt"></i> Mapa
                        </button>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                            <i class="bi bi-plus-circle"></i> Novo Dispositivo
                        </button>
                        <!-- Ícone de configuração -->
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#configModal"
                            title="Configurações">
                            <i class="bi bi-gear"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Alertas -->
            <div id="alertContainer" class="mb-4"></div>

            <!-- Indicador de carregamento -->
            <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando dispositivos...</p>
            </div>

            <!-- Card de Estatísticas -->
            <div id="statsContainer" class="mb-4" style="display: none;">
                <div class="col-3 card stats-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-grid-3x3-gap me-2 fs-4"></i>
                                    <h5 class="card-title mb-1 text-white">
                                        Total de Dispositivos
                                    </h5>
                                </div>
                                <h2 class="mb-1" id="totalDispositivos">0</h2>
                                <small class="text-white-50">dispositivos cadastrados</small>
                            </div>
                            <div class="stats-icon">
                                <i class="bi bi-bar-chart fs-1 text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensagem quando não há dispositivos -->
            <div id="noDevices" class="text-center py-5" style="display: none;">
                <div class="mb-4">
                    <i class="bi bi-tv display-1 text-muted"></i>
                </div>
                <h4 class="text-muted mb-3">Nenhum dispositivo encontrado</h4>
                <p class="text-muted mb-4">Comece criando seu primeiro dispositivo para gerenciar suas telas de
                    exibição.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="bi bi-plus-circle me-2"></i>Criar Primeiro Dispositivo
                </button>
            </div>

            <!-- Container dos Dispositivos -->
            <div class="row" id="dispositivosContainer">
            </div>
    </div>

    <!-- Botão flutuante para dispositivos móveis -->
    <button class="mobile-toggle d-lg-none">
        <i class="bi bi-list"></i>
    </button>
    </main>
    </div>

    <!-- Modal: Adicionar Dispositivo -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form id="formAddDevice" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Coluna Esquerda: Campos Principais -->
                        <div class="col-md-6">

                            <!-- Campos da Chave do Dispositivo (6 caixas) -->
                            <div class="mb-3">
                                <label class="form-label">Chave do Dispositivo (6 dígitos)</label>
                                <div id="deviceKeyContainer" class="d-flex justify-content-between align-items-center">
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="0" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="1" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="2" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="3" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="4" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="5" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="deviceName" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="deviceName" required>
                            </div>
                            <div class="mb-3">
                                <label for="deviceFormat" class="form-label">Formato</label>
                                <select class="form-select" id="deviceFormat" required>
                                    <option value="HORIZONTAL">Horizontal</option>
                                    <option value="VERTICAL">Vertical</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="devicePanelId" class="form-label">Painel</label>
                                <select class="form-select" id="devicePanelId" required>
                                    <option value="">Carregando painéis...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="deviceType" class="form-label">Tipo</label>
                                <select class="form-select" id="deviceType" required>
                                    <option value="TV">TV</option>
                                    <option value="MONITOR">Monitor</option>
                                    <option value="TABLET">Tablet</option>
                                    <option value="TOTEM">Totem</option>
                                    <option value="LED_PANEL">Painel de LED</option>
                                    <option value="PROJECTOR">Projetor</option>
                                    <option value="PC">PC</option>
                                </select>
                            </div>
                        </div>
                        <!-- Coluna Direita: Geo Localização e Notificações -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Geo Localização (Opcional)</label>
                                <div class="card geo-card">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-tabs card-header-tabs geo-tabs" id="geoLocationTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="coordinates-tab" data-bs-toggle="tab" data-bs-target="#coordinates" type="button" role="tab">Coordenadas</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab">Endereço</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="cep-tab" data-bs-toggle="tab" data-bs-target="#cep" type="button" role="tab">CEP</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button" role="tab">Mapa</button>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="tab-content" id="geoLocationTabContent">
                                            <!-- Aba Coordenadas -->
                                            <div class="tab-pane fade show active" id="coordinates" role="tabpanel">
                                                <input type="text" class="form-control" id="deviceGeoLocation"
                                                    placeholder="Ex: -23.550520, -46.633308">
                                                <small class="form-text text-muted">Digite as coordenadas de latitude e longitude separadas por vírgula.</small>
                                            </div>
                                            <!-- Aba Endereço -->
                                            <div class="tab-pane fade" id="address" role="tabpanel">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="deviceAddress"
                                                        placeholder="Ex: Rua das Flores, 123, São Paulo, SP">
                                                    <button class="btn btn-outline-primary" type="button" id="searchByAddress">
                                                        <i class="bi bi-search"></i> Buscar
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted">Digite o endereço completo para buscar as coordenadas.</small>
                                            </div>
                                            <!-- Aba CEP -->
                                            <div class="tab-pane fade" id="cep" role="tabpanel">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="deviceCep"
                                                        placeholder="Ex: 01310-100" maxlength="9">
                                                    <button class="btn btn-outline-primary" type="button" id="searchByCep">
                                                        <i class="bi bi-search"></i> Buscar
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted">Digite o CEP para buscar as coordenadas.</small>
                                                <div id="cepResult" class="mt-2" style="display: none;">
                                                    <small class="text-success">Endereço encontrado: <span id="foundAddress"></span></small>
                                                </div>
                                            </div>
                                            <!-- Aba Mapa -->
                                            <div class="tab-pane fade" id="map" role="tabpanel">
                                                <div id="createMap" style="height: 300px; border-radius: 8px;"></div>
                                                <small class="form-text text-muted mt-2 d-block">Clique no mapa para selecionar a localização do dispositivo.</small>
                                            </div>
                                        </div>
                                        <!-- Área de alertas para geolocalização (criação) -->
                                        <div id="createGeoAlerts" class="mt-2 geo-alert-container"></div>
                                        <!-- Resultado das coordenadas -->
                                        <div id="coordinatesResult" class="mt-2" style="display: none;">
                                            <div class="alert alert-success py-2">
                                                <i class="bi bi-geo-alt-fill"></i>
                                                <strong>Coordenadas encontradas:</strong> <span id="foundCoordinates"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="deviceSendNotification">
                                    <label class="form-check-label" for="deviceSendNotification">
                                        Enviar Notificações Slack
                                    </label>
                                    <small class="form-text text-muted d-block">Receber notificações quando o
                                        dispositivo ficar offline.</small>

                                </div>
                                <div class="alert alert-warning mt-2" role="alert">
                                    <i class="bi bi-info-circle"></i>
                                    Necessário configurar a WEBHOOK e ter um canal cadastrado no SLACK.
                                    <a href="https://slack.com/intl/pt-br/help/articles/206845317-Criar-um-webhook-para-o-Slack"
                                        target="_blank">Clique aqui para saber como configurar.</a>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="deviceShowClientInfo">
                                    <label class="form-check-label" for="deviceShowClientInfo">
                                        Mostrar Informações do Cliente
                                    </label>
                                </div>
                                <div class="alert alert-info mt-2" role="alert">
                                    <i class="bi bi-info-circle"></i>
                                    Caso marcado, a barra inferior com sua LOGO e texto personalizado aparecerá no
                                    display deste dispositivo.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Dispositivo -->
    <div class="modal fade" id="editDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form id="formEditDevice" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editDeviceId">
                    <div class="row">
                        <!-- Coluna Esquerda: Campos Principais -->
                        <div class="col-md-6">

                            <!-- Campos da Chave do Dispositivo (6 caixas) para Edição -->
                            <div class="mb-3">
                                <label class="form-label">Chave do Dispositivo (6 dígitos, maiúsculas)</label>
                                <div id="editDeviceKeyContainer"
                                    class="d-flex justify-content-between align-items-center">
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="0" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="1" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="2" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="3" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="4" required>
                                    <input type="text" class="form-control device-key-input mx-1" maxlength="1"
                                        data-index="5" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceName" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="editDeviceName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceFormat" class="form-label">Formato</label>
                                <select class="form-select" id="editDeviceFormat" required>
                                    <option value="HORIZONTAL">Horizontal</option>
                                    <option value="VERTICAL">Vertical</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDevicePanelId" class="form-label">Painel</label>
                                <select class="form-select" id="editDevicePanelId" required>
                                    <option value="">Carregando painéis...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceType" class="form-label">Tipo</label>
                                <select class="form-select" id="editDeviceType" required>
                                    <option value="TV">TV</option>
                                    <option value="MONITOR">Monitor</option>
                                    <option value="TABLET">Tablet</option>
                                    <option value="TOTEM">Totem</option>
                                    <option value="LED_PANEL">Painel de LED</option>
                                    <option value="PROJECTOR">Projetor</option>
                                    <option value="PC">PC</option>
                                </select>
                            </div>
                        </div>
                        <!-- Coluna Direita: Geo Localização e Notificações para Edição -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Geo Localização (Opcional)</label>
                                <div class="card geo-card">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-tabs card-header-tabs geo-tabs" id="editGeoLocationTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="edit-coordinates-tab" data-bs-toggle="tab" data-bs-target="#edit-coordinates" type="button" role="tab">Coordenadas</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="edit-address-tab" data-bs-toggle="tab" data-bs-target="#edit-address" type="button" role="tab">Endereço</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="edit-cep-tab" data-bs-toggle="tab" data-bs-target="#edit-cep" type="button" role="tab">CEP</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="edit-map-tab" data-bs-toggle="tab" data-bs-target="#edit-map" type="button" role="tab">Mapa</button>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="tab-content" id="editGeoLocationTabContent">
                                            <!-- Aba Coordenadas -->
                                            <div class="tab-pane fade show active" id="edit-coordinates" role="tabpanel">
                                                <input type="text" class="form-control" id="editDeviceGeoLocation"
                                                    placeholder="Ex: -23.550520, -46.633308">
                                                <small class="form-text text-muted">Digite as coordenadas de latitude e longitude separadas por vírgula.</small>
                                            </div>
                                            <!-- Aba Endereço -->
                                            <div class="tab-pane fade" id="edit-address" role="tabpanel">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="editDeviceAddress"
                                                        placeholder="Ex: Rua das Flores, 123, São Paulo, SP">
                                                    <button class="btn btn-outline-primary" type="button" id="editSearchByAddress">
                                                        <i class="bi bi-search"></i> Buscar
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted">Digite o endereço completo para buscar as coordenadas.</small>
                                            </div>
                                            <!-- Aba CEP -->
                                            <div class="tab-pane fade" id="edit-cep" role="tabpanel">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="editDeviceCep"
                                                        placeholder="Ex: 01310-100" maxlength="9">
                                                    <button class="btn btn-outline-primary" type="button" id="editSearchByCep">
                                                        <i class="bi bi-search"></i> Buscar
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted">Digite o CEP para buscar as coordenadas.</small>
                                                <div id="editCepResult" class="mt-2" style="display: none;">
                                                    <small class="text-success">Endereço encontrado: <span id="editFoundAddress"></span></small>
                                                </div>
                                            </div>
                                            <!-- Aba Mapa -->
                                            <div class="tab-pane fade" id="edit-map" role="tabpanel">
                                                <div id="editMap" style="height: 300px; border-radius: 8px;"></div>
                                                <small class="form-text text-muted mt-2 d-block">Clique no mapa para selecionar a localização do dispositivo.</small>
                                            </div>
                                        </div>
                                        <!-- Área de alertas para geolocalização (edição) -->
                                        <div id="editGeoAlerts" class="mt-2 geo-alert-container"></div>
                                        <!-- Resultado das coordenadas -->
                                        <div id="editCoordinatesResult" class="mt-2" style="display: none;">
                                            <div class="alert alert-success py-2">
                                                <i class="bi bi-geo-alt-fill"></i>
                                                <strong>Coordenadas encontradas:</strong> <span id="editFoundCoordinates"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editDeviceSendNotification">
                                    <label class="form-check-label" for="editDeviceSendNotification">
                                        Enviar Notificações Slack
                                    </label>
                                    <small class="form-text text-muted d-block">Receber notificações quando o
                                        dispositivo ficar offline.</small>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-2" role="alert">
                                    <i class="bi bi-info-circle"></i>
                                    Necessário configurar a WEBHOOK e ter um canal cadastrado no SLACK.
                                    <a href="https://slack.com/intl/pt-br/help/articles/206845317-Criar-um-webhook-para-o-Slack"
                                        target="_blank">Clique aqui para saber como configurar.</a>
                                </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editDeviceShowClientInfo">
                                    <label class="form-check-label" for="editDeviceShowClientInfo">
                                        Mostrar Informações do Cliente
                                    </label>
                                </div>
                                <div class="alert alert-info mt-2" role="alert">
                                    <i class="bi bi-info-circle"></i>
                                    Caso marcado, a barra inferior com sua LOGO e texto personalizado aparecerá no
                                    display deste dispositivo.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Mapa dos Dispositivos -->
    <div class="modal fade" id="devicesMapModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-geo-alt me-2"></i>Mapa dos Dispositivos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="devicesMap" style="height: 70vh; width: 100%;"></div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="legend d-flex gap-3">
                            <div class="d-flex align-items-center">
                                <div class="legend-icon online me-2"></div>
                                <small>Online</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="legend-icon offline me-2"></div>
                                <small>Offline</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script do Bootstrap (deve ser o último antes do seu script personalizado) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script personalizado da dashboard -->
    <script src="modern-dashboard.js"></script>
    <script>
        // ===== VARIÁVEIS GLOBAIS =====
        const token = localStorage.getItem('token');
        const userName = localStorage.getItem('userName');
        const alertContainer = document.getElementById('alertContainer');

        // ===== VERIFICAÇÃO DE AUTENTICAÇÃO =====
        if (!token) {
            window.location.href = "login.html";
        }

       // Função para atualizar a logo do usuário na sidebar (corrigida)
    function updateUserLogo(avatarUrl) {
      const sidebarLogo = document.querySelector('.sidebar-header img');
      if (sidebarLogo && avatarUrl) {
        sidebarLogo.src = `${avatarUrl}?t=${Date.now()}`;
        // Preservar a imagem original e centralizá-la
        sidebarLogo.style.borderRadius = '0'; // Remove o formato circular
        sidebarLogo.style.width = 'auto'; // Largura automática
        sidebarLogo.style.height = '60px'; // Altura fixa para manter proporção
        sidebarLogo.style.maxWidth = '100%'; // Não exceder a largura do container
        sidebarLogo.style.objectFit = 'contain'; // Manter proporções sem cortar
        sidebarLogo.style.display = 'block';
        sidebarLogo.style.margin = '0 auto'; // Centralizar horizontalmente
        sidebarLogo.style.border = 'none'; // Remove bordas
        sidebarLogo.style.boxShadow = 'none'; // Remove sombras
      }
    }
        // Função para mostrar alertas Bootstrap
        function mostrarAlerta(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' :
                type === 'warning' ? 'alert-warning' : 'alert-danger';
            const icon = type === 'success' ? 'bi-check-circle' :
                type === 'warning' ? 'bi-exclamation-triangle' : 'bi-exclamation-triangle';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi ${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            alertContainer.innerHTML = alertHtml;

            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Alias para compatibilidade com código existente
        const showAlert = mostrarAlerta;

        // Função para carregar e exibir dispositivos
        async function carregarDispositivos() {
            const container = document.getElementById('dispositivosContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const statsContainer = document.getElementById('statsContainer');
            const noDevices = document.getElementById('noDevices');

            // Mostrar indicador de carregamento
            loadingIndicator.style.display = 'block';
            statsContainer.style.display = 'none';
            noDevices.style.display = 'none';
            container.innerHTML = '';
            document.getElementById('totalDispositivos').textContent = '0';

            try {
                const resposta = await fetch(`${APP_CONFIG.API_BASE_URL}${APP_CONFIG.API_ENDPOINTS.DEVICES}`, {
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('token')
                    }
                });

                if (!resposta.ok) {
                    const errorData = await resposta.json();
                    throw new Error(errorData.message || 'Erro ao carregar dispositivos');
                }

                const dispositivos = await resposta.json();

                // Esconder indicador de carregamento
                loadingIndicator.style.display = 'none';

                if (!Array.isArray(dispositivos) || dispositivos.length === 0) {
                    noDevices.style.display = 'block';
                    statsContainer.style.display = 'none';
                    document.getElementById('totalDispositivos').textContent = '0';
                    return;
                }

                const formatarData = (data) => {
                    if (!data) return '-';
                    const d = new Date(data);
                    return d.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                };

                container.innerHTML = dispositivos.map(device => {
                    const statusDeviceBadge = device.statusDevice
                        ? '<span class="badge bg-success">Online</span>'
                        : '<span class="badge bg-danger">Offline</span>';
                    const ativoInativoBadge = device.status === 'Ativo'
                        ? '<span class="badge bg-primary">Ativo</span>'
                        : '<span class="badge bg-secondary">Inativo</span>';

                    return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 shadow-sm card-hover">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h5>${device.name}</h5>
                                    <div>${ativoInativoBadge} ${statusDeviceBadge}</div>
                                </div>
                                <p><small class="text-muted">Criado: ${formatarData(device.createdAt)}</small></p>
                                <p><small class="text-muted">Tipo: ${device.type}</small></p>
                                <p><small class="text-muted">Formato: ${device.format}</small></p>
                                <p><small class="text-muted">Painel: ${device.panel?.name || 'N/A'}</small></p>
                                
                                
                                <p><small class="text-muted">Chave: <code>${device.deviceKey}</code></small></p>
                                ${device.geoLocation ? `<p><small class="text-muted">Localização: ${device.geoLocation}</small></p>` : ''}
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editarDispositivo(${device.id})">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="excluirDispositivo(${device.id}, '${device.name}')">
                                        <i class="bi bi-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // Mostrar card de estatísticas e atualizar contador
                statsContainer.style.display = 'block';
                noDevices.style.display = 'none';
                document.getElementById('totalDispositivos').textContent = dispositivos.length;

            } catch (err) {
                loadingIndicator.style.display = 'none';
                container.innerHTML = `<div class="col-12"><div class="alert alert-danger">Erro: ${err.message}</div></div>`;
                statsContainer.style.display = 'none';
                noDevices.style.display = 'none';
                showAlert(`Erro ao carregar dispositivos: ${err.message}`, 'danger');
            }
        }

        // Função para carregar painéis para o dropdown (agora reutilizável)
        // O parâmetro `targetSelectId` permite especificar qual select HTML será populado
        async function carregarPaineis(targetSelectId = 'devicePanelId', selectedPanelId = null) {
            try {
                // CORREÇÃO: Endpoint para buscar painéis do usuário logado (sem /public)
                const res = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.PANELS), {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || `Erro ao carregar painéis: Status ${res.status}`);
                }
                const paineis = await res.json();
                const selectPanel = document.getElementById(targetSelectId);
                selectPanel.innerHTML = ''; // Limpa opções existentes

                if (paineis.length === 0) {
                    selectPanel.innerHTML = '<option value="">Nenhum painel disponível</option>';
                    selectPanel.disabled = true;
                    showAlert('Nenhum painel encontrado para este usuário. Por favor, cadastre um painel primeiro.', 'warning');
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Selecione um painel...";
                    defaultOption.disabled = true;
                    defaultOption.selected = true; // Define como selecionada por padrão
                    selectPanel.appendChild(defaultOption);

                    paineis.forEach(panel => {
                        const option = document.createElement('option');
                        option.value = panel.id;
                        option.textContent = panel.name;
                        if (selectedPanelId !== null && panel.id === selectedPanelId) {
                            option.selected = true; // Pré-seleciona o painel do dispositivo
                            defaultOption.selected = false; // Deseleciona a opção padrão
                        }
                        selectPanel.appendChild(option);
                    });
                    selectPanel.disabled = false;
                }
            } catch (err) {
                console.error('Erro ao carregar painéis:', err.message);
                const selectPanel = document.getElementById(targetSelectId);
                selectPanel.innerHTML = '<option value="">Erro ao carregar painéis</option>';
                selectPanel.disabled = true;
                showAlert(`Erro ao carregar painéis: ${err.message}`, 'danger');
            }
        }

        // Função genérica para inicializar inputs da chave do dispositivo (add e edit)
        function initializeDeviceKeyInputs(containerId) {
            const keyInputs = document.querySelectorAll(`#${containerId} .device-key-input`);

            keyInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.toUpperCase(); // Converte para maiúsculas imediatamente
                    e.target.value = value; // Atualiza o campo de input

                    if (value.length === 1) { // Se um caractere foi inserido
                        if (index < keyInputs.length - 1) {
                            keyInputs[index + 1].focus(); // Move o foco para o próximo input
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '') {
                        if (index > 0) {
                            keyInputs[index - 1].focus(); // Move o foco para o input anterior
                            e.preventDefault(); // Previne o comportamento padrão do backspace no input vazio atual
                        }
                    } else if (e.key.length === 1 && !/[a-zA-Z0-9]/.test(e.key)) {
                        // Previne a entrada de caracteres não alfanuméricos
                        e.preventDefault();
                    }
                });

                // Adiciona listener para garantir que o paste também converta para maiúsculas e distribua
                input.addEventListener('paste', (e) => {
                    e.preventDefault(); // Previne o paste padrão
                    const pasteData = e.clipboardData.getData('Text').toUpperCase();
                    let currentInputIndex = index;
                    for (let i = 0; i < pasteData.length && currentInputIndex < keyInputs.length; i++) {
                        keyInputs[currentInputIndex].value = pasteData[i];
                        currentInputIndex++;
                    }
                    // Foca no último input preenchido ou no último da sequência
                    if (currentInputIndex < keyInputs.length) {
                        keyInputs[currentInputIndex].focus();
                    } else {
                        keyInputs[keyInputs.length - 1].focus();
                    }
                });
            });
        }


        // Função para abrir modal de edição e preencher dados
        async function editarDispositivo(id) {
            try {
                // Endpoint CORRIGIDO: usa /device para buscar um dispositivo específico
                const res = await fetch(buildApiUrl(`${APP_CONFIG.API_ENDPOINTS.DEVICE}/${id}`), {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao buscar dispositivo para edição');
                }

                const device = await res.json();

                // Preencher campos do modal de edição
                document.getElementById('editDeviceId').value = device.id;
                document.getElementById('editDeviceName').value = device.name;
                document.getElementById('editDeviceFormat').value = device.format;
                document.getElementById('editDeviceType').value = device.type;
                document.getElementById('editDeviceGeoLocation').value = device.geoLocation || ''; // Preenche ou vazio
                document.getElementById('editDeviceSendNotification').checked = device.sendNotification !== false; // Default true se não definido
                document.getElementById('editDeviceShowClientInfo').checked = device.showClientInfo || false; // Default false se não definido

                // Preencher os inputs da chave do dispositivo
                const editKeyInputs = document.querySelectorAll('#editDeviceKeyContainer .device-key-input');
                if (device.deviceKey) {
                    device.deviceKey.split('').forEach((char, index) => {
                        if (editKeyInputs[index]) {
                            editKeyInputs[index].value = char;
                        }
                    });
                } else {
                    editKeyInputs.forEach(input => input.value = ''); // Limpa se não houver chave
                }

                // Carregar e pré-selecionar o painel
                await carregarPaineis('editDevicePanelId', device.panelId);


                // Abrir o modal
                new bootstrap.Modal(document.getElementById('editDeviceModal')).show();

                // Inicializar a lógica dos inputs da chave para o modal de edição
                initializeDeviceKeyInputs('editDeviceKeyContainer');
                // Opcional: foca no primeiro input da chave do modal de edição
                document.querySelector('#editDeviceKeyContainer .device-key-input')?.focus();

            } catch (err) {
                showAlert(`Erro ao carregar dispositivo para edição: ${err.message}`, 'danger');
            }
        }

        // Função para excluir dispositivo
        async function excluirDispositivo(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o dispositivo "${nome}"?`)) return;

            try {
                // CORRIGIDO: usa DEVICE (singular) para excluir um dispositivo específico
                const res = await fetch(buildApiUrl(`${APP_CONFIG.API_ENDPOINTS.DEVICE}/${id}`), {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao excluir dispositivo');
                }
                showAlert('Dispositivo excluído com sucesso!', 'success');
                carregarDispositivos();
            } catch (err) {
                showAlert(`Erro ao excluir dispositivo: ${err.message}`, 'danger');
            }
        }

        // Event Listener para adicionar dispositivo
        document.getElementById('formAddDevice').addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('deviceName').value;

            // Coleta a chave do dispositivo dos 6 inputs e concatena
            const keyInputs = document.querySelectorAll('#deviceKeyContainer .device-key-input');
            const deviceKey = Array.from(keyInputs).map(input => input.value).join('').toUpperCase(); // Garante maiúsculas

            const format = document.getElementById('deviceFormat').value;
            const panelId = parseInt(document.getElementById('devicePanelId').value);
            const type = document.getElementById('deviceType').value;
            const geoLocation = document.getElementById('deviceGeoLocation').value.trim();

            // Validações básicas
            if (isNaN(panelId)) {
                showAlert('Por favor, selecione um painel válido.', 'danger');
                return;
            }
            if (!/^[A-Z0-9]{6}$/.test(deviceKey)) {
                showAlert('A Chave do Dispositivo deve ter 6 dígitos alfanuméricos maiúsculos (Ex: A1B2C3).', 'danger');
                return;
            }

            const sendNotification = document.getElementById('deviceSendNotification').checked;
            const showClientInfo = document.getElementById('deviceShowClientInfo').checked;

            const deviceData = {
                name,
                deviceKey,
                format,
                panelId,
                type,
                sendNotification,
                showClientInfo,
            };
            if (geoLocation) {
                deviceData.geoLocation = geoLocation;
            }

            try {
                // CORRIGIDO: usa DEVICE (singular) para criar um novo dispositivo
                const res = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.DEVICE), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(deviceData)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao adicionar dispositivo');
                }

                bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
                showAlert('Dispositivo adicionado com sucesso!', 'success');
                document.getElementById('formAddDevice').reset(); // Limpa os campos do formulário
                keyInputs.forEach(input => input.value = ''); // Limpa explicitamente os inputs da chave
                carregarDispositivos(); // Recarrega a lista de dispositivos
            } catch (err) {
                showAlert(`Erro ao adicionar dispositivo: ${err.message}`, 'danger');
            }
        });

        // Event Listener para editar dispositivo
        document.getElementById('formEditDevice').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('editDeviceId').value;
            const name = document.getElementById('editDeviceName').value;

            // Coleta a chave do dispositivo dos 6 inputs de edição e concatena
            const editKeyInputs = document.querySelectorAll('#editDeviceKeyContainer .device-key-input');
            const deviceKey = Array.from(editKeyInputs).map(input => input.value).join('').toUpperCase();

            const format = document.getElementById('editDeviceFormat').value;
            const panelId = parseInt(document.getElementById('editDevicePanelId').value);
            const type = document.getElementById('editDeviceType').value;
            const geoLocation = document.getElementById('editDeviceGeoLocation').value.trim();

            // Validações básicas para edição
            if (isNaN(panelId)) {
                showAlert('Por favor, selecione um painel válido.', 'danger');
                return;
            }
            if (!/^[A-Z0-9]{6}$/.test(deviceKey)) {
                showAlert('A Chave do Dispositivo deve ter 6 dígitos alfanuméricos maiúsculos (Ex: A1B2C3).', 'danger');
                return;
            }

            const sendNotification = document.getElementById('editDeviceSendNotification').checked;
            const showClientInfo = document.getElementById('editDeviceShowClientInfo').checked;

            const deviceData = {
                name,
                deviceKey,
                format,
                panelId,
                type,
                sendNotification,
                showClientInfo,
            };
            if (geoLocation) {
                deviceData.geoLocation = geoLocation;
            }

            try {
                // CORRIGIDO: usa DEVICE (singular) para atualizar um dispositivo específico
                const res = await fetch(buildApiUrl(`${APP_CONFIG.API_ENDPOINTS.DEVICE}/${id}`), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(deviceData)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erro ao atualizar dispositivo');
                }
                bootstrap.Modal.getInstance(document.getElementById('editDeviceModal')).hide();
                showAlert('Dispositivo atualizado com sucesso!', 'success');
                carregarDispositivos();
            } catch (err) {
                showAlert(`Erro ao atualizar dispositivo: ${err.message}`, 'danger');
            }
        });

        // Função para lidar com o logout
        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userName');
            window.location.href = 'login.html';
        }

        // Função para definir o link ativo na sidebar
        function setActiveSidebarLink() {
            const currentPage = window.location.pathname.split('/').pop();
            const sidebarLinks = document.querySelectorAll('.sidebar-link');

            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPage) {
                    link.classList.add('active');
                }
            });
        }

        // Função para ir para a página de dispositivos (se for diferente da atual)
        function irParaDispositivos() {
            window.location.href = 'dispositivos.html';
        }


        // Carrega dispositivos e painéis quando a página é carregada
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticação
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Preencher nome do usuário
            if (userName) {
                document.getElementById('userNameDisplay').textContent = userName;
            }

            // Definir link ativo na sidebar
            setActiveSidebarLink();

            // Anexar evento de logout
            document.getElementById('logoutBtnSidebar').addEventListener('click', handleLogout);

            // Inicializar tema escuro se necessário
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }

            // Carregar dados
            carregarDispositivos();
            carregarPaineis(); // Carrega painéis para o modal de adição por padrão
        });

        // Inicializa os inputs da chave do dispositivo quando o modal de ADIÇÃO é aberto
        document.getElementById('addDeviceModal').addEventListener('shown.bs.modal', () => {
            initializeDeviceKeyInputs('deviceKeyContainer');
            document.querySelector('#deviceKeyContainer .device-key-input')?.focus();
        });

        // Limpa os inputs da chave do dispositivo quando o modal de ADIÇÃO é fechado
        document.getElementById('addDeviceModal').addEventListener('hidden.bs.modal', () => {
            const keyInputs = document.querySelectorAll('#deviceKeyContainer .device-key-input');
            keyInputs.forEach(input => input.value = '');
            // Limpar outros campos manualmente se o reset() não pegar todos os inputs dinâmicos
            document.getElementById('formAddDevice').reset();
            // Recarregar paineis para garantir que o estado inicial esteja correto, caso não tenha painel selecionado
            carregarPaineis();
        });

        // ===== MODAL DE CONFIGURAÇÃO =====
        // Toggle de tema
        const themeToggle = document.getElementById('themeToggle');
        const themeToggleModal = document.getElementById('themeToggleModal');
        const body = document.body;

        // Verificar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-theme');
            if (themeToggle) themeToggle.checked = true;
            if (themeToggleModal) themeToggleModal.checked = true;
        }

        // Função para alternar tema
        function toggleTheme(isDark) {
            if (isDark) {
                body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
            }
            // Sincronizar ambos os toggles
            if (themeToggle) themeToggle.checked = isDark;
            if (themeToggleModal) themeToggleModal.checked = isDark;
        }

        if (themeToggle) {
            themeToggle.addEventListener('change', function () {
                toggleTheme(this.checked);
            });
        }

        if (themeToggleModal) {
            themeToggleModal.addEventListener('change', function () {
                toggleTheme(this.checked);
            });
        }

        // ===== BUSCA EM TEMPO REAL =====
        document.getElementById('searchDevice').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase().trim();
            const deviceCards = document.querySelectorAll('#dispositivosContainer .col-md-6');
            let visibleCount = 0;

            deviceCards.forEach(card => {
                const deviceName = card.querySelector('h5').textContent.toLowerCase();
                const deviceType = card.querySelector('.text-muted').textContent.toLowerCase();
                const deviceKey = card.querySelector('code').textContent.toLowerCase();

                const isVisible = deviceName.includes(searchTerm) ||
                    deviceType.includes(searchTerm) ||
                    deviceKey.includes(searchTerm);

                if (isVisible) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Atualizar contador baseado na busca
            if (searchTerm === '') {
                // Se não há termo de busca, mostrar total real
                const totalDevices = deviceCards.length;
                document.getElementById('totalDispositivos').textContent = totalDevices;
            } else {
                // Se há busca, mostrar apenas dispositivos visíveis
                document.getElementById('totalDispositivos').textContent = visibleCount;
            }
        });

        // Carregar informações do usuário no modal
        const userNameModal = document.getElementById('userNameModal');
        const userEmailModal = document.getElementById('userEmailModal');
        if (userNameModal) userNameModal.textContent = userName || 'Usuário';
        if (userEmailModal) userEmailModal.textContent = userEmail || 'usuario@email.com';

        // Logout do modal
        const logoutBtnModal = document.getElementById('logoutBtnModal');
        if (logoutBtnModal) {
            logoutBtnModal.addEventListener('click', function () {
                if (confirm('Tem certeza que deseja sair?')) {
                    localStorage.removeItem('usuarioEmail');
                    localStorage.removeItem('usuarioName');
                    localStorage.removeItem('token');
                    window.location.href = '/';
                }
            });
        }

        // Função para mostrar alertas específicos de geolocalização nos modais
        function showGeoAlert(message, type = 'success', isEdit = false) {
            const alertContainer = isEdit ? document.getElementById('editGeoAlerts') : document.getElementById('createGeoAlerts');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-danger';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show py-2" role="alert">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-x-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Funções de Geocoding
        async function searchByAddress(address, isEdit = false) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    const coordinates = `${lat}, ${lon}`;
                    
                    // Atualizar campos baseado no contexto (criação ou edição)
                    const geoLocationInput = isEdit ? document.getElementById('editDeviceGeoLocation') : document.getElementById('deviceGeoLocation');
                    const coordinatesResult = isEdit ? document.getElementById('editCoordinatesResult') : document.getElementById('coordinatesResult');
                    const foundCoordinates = isEdit ? document.getElementById('editFoundCoordinates') : document.getElementById('foundCoordinates');
                    
                    geoLocationInput.value = coordinates;
                    foundCoordinates.textContent = coordinates;
                    coordinatesResult.style.display = 'block';
                    
                    // Centralizar mapa se estiver ativo
                    const map = isEdit ? editMap : createMap;
                    if (map) {
                        centerMapOnCoordinates(coordinates, isEdit);
                    }
                    
                    showGeoAlert('Coordenadas encontradas com sucesso!', 'success', isEdit);
                } else {
                    showGeoAlert('Endereço não encontrado. Tente ser mais específico.', 'warning', isEdit);
                }
            } catch (error) {
                console.error('Erro ao buscar endereço:', error);
                showGeoAlert('Erro ao buscar coordenadas do endereço.', 'danger', isEdit);
            }
        }

        async function searchByCep(cep, isEdit = false) {
            try {
                // Limpar CEP (remover caracteres não numéricos)
                const cleanCep = cep.replace(/\D/g, '');
                
                if (cleanCep.length !== 8) {
                    showGeoAlert('CEP deve ter 8 dígitos.', 'warning', isEdit);
                    return;
                }
                
                // Buscar endereço pelo CEP na API ViaCEP
                const cepResponse = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                const cepData = await cepResponse.json();
                
                if (cepData.erro) {
                    showGeoAlert('CEP não encontrado.', 'warning', isEdit);
                    return;
                }
                
                // Mostrar endereço encontrado
                const address = `${cepData.logradouro}, ${cepData.bairro}, ${cepData.localidade}, ${cepData.uf}`;
                const cepResult = isEdit ? document.getElementById('editCepResult') : document.getElementById('cepResult');
                const foundAddress = isEdit ? document.getElementById('editFoundAddress') : document.getElementById('foundAddress');
                
                foundAddress.textContent = address;
                cepResult.style.display = 'block';
                
                // Buscar coordenadas do endereço
                await searchByAddress(address, isEdit);
                
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                showGeoAlert('Erro ao buscar CEP.', 'danger', isEdit);
            }
        }

        // Formatação automática do CEP
        function formatCep(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            input.value = value;
        }

        // Event Listeners para busca por endereço (criação)
        document.getElementById('searchByAddress').addEventListener('click', function() {
            const address = document.getElementById('deviceAddress').value.trim();
            if (address) {
                searchByAddress(address, false);
            } else {
                showGeoAlert('Digite um endereço para buscar.', 'warning', false);
            }
        });

        // Event Listeners para busca por CEP (criação)
        document.getElementById('searchByCep').addEventListener('click', function() {
            const cep = document.getElementById('deviceCep').value.trim();
            if (cep) {
                searchByCep(cep, false);
            } else {
                showGeoAlert('Digite um CEP para buscar.', 'warning', false);
            }
        });

        // Event Listeners para busca por endereço (edição)
        document.getElementById('editSearchByAddress').addEventListener('click', function() {
            const address = document.getElementById('editDeviceAddress').value.trim();
            if (address) {
                searchByAddress(address, true);
            } else {
                showGeoAlert('Digite um endereço para buscar.', 'warning', true);
            }
        });

        // Event Listeners para busca por CEP (edição)
        document.getElementById('editSearchByCep').addEventListener('click', function() {
            const cep = document.getElementById('editDeviceCep').value.trim();
            if (cep) {
                searchByCep(cep, true);
            } else {
                showGeoAlert('Digite um CEP para buscar.', 'warning', true);
            }
        });

        // Formatação automática do CEP nos inputs
        document.getElementById('deviceCep').addEventListener('input', function() {
            formatCep(this);
        });

        document.getElementById('editDeviceCep').addEventListener('input', function() {
            formatCep(this);
        });

        

    </script>

    <!-- Modal de Configuração -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content geo-modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel">
                        <i class="bi bi-gear me-2"></i>Configurações
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informações do usuário -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-person-circle me-2"></i>Usuário Logado
                        </h6>
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <div class="me-3">
                                <i class="bi bi-person-circle text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <div>
                                <div class="fw-semibold" id="userNameModal">Usuário</div>
                                <div class="text-muted small" id="userEmailModal">usuario@email.com</div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações de tema -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-palette me-2"></i>Aparência
                        </h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="themeToggleModal">
                            <label class="form-check-label" for="themeToggleModal">
                                <i class="bi bi-moon me-2"></i>Modo Escuro
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Fechar
                    </button>
                    <button type="button" class="btn btn-danger" id="logoutBtnModal">
                        <i class="bi bi-box-arrow-right me-1"></i>Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Variáveis globais para os mapas
        let createMap, editMap;
        let createMarker, editMarker;
        
        // Função para inicializar o mapa de criação
        function initCreateMap() {
            if (createMap) {
                createMap.remove();
            }
            
            createMap = L.map('createMap').setView([-23.550520, -46.633308], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(createMap);
            
            createMap.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                
                // Remove marcador anterior se existir
                if (createMarker) {
                    createMap.removeLayer(createMarker);
                }
                
                // Adiciona novo marcador
                createMarker = L.marker([lat, lng]).addTo(createMap);
                
                // Atualiza o campo de coordenadas
                document.getElementById('deviceGeoLocation').value = `${lat}, ${lng}`;
                
                // Mostra alerta de sucesso
                showGeoAlert(`Localização selecionada: ${lat}, ${lng}`, 'success', false);
            });
        }
        
        // Função para inicializar o mapa de edição
        function initEditMap() {
            if (editMap) {
                editMap.remove();
            }
            
            // Coordenadas padrão (Fortaleza, CE)
            let defaultLat = -3.7246997469328127;
            let defaultLng = -38.52683830224771;
            let zoom = 10;
            
            // Verificar se há coordenadas existentes no campo
            const existingCoords = document.getElementById('editDeviceGeoLocation').value;
            if (existingCoords && existingCoords.trim() !== '') {
                const coords = existingCoords.split(',').map(coord => parseFloat(coord.trim()));
                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                    defaultLat = coords[0];
                    defaultLng = coords[1];
                    zoom = 15; // Zoom maior para localização específica
                }
            }
            
            editMap = L.map('editMap').setView([defaultLat, defaultLng], zoom);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(editMap);
            
            // Adicionar marcador se há coordenadas válidas
            if (existingCoords && existingCoords.trim() !== '') {
                const coords = existingCoords.split(',').map(coord => parseFloat(coord.trim()));
                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                    editMarker = L.marker([coords[0], coords[1]]).addTo(editMap);
                }
            }
            
            editMap.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                
                // Remove marcador anterior se existir
                if (editMarker) {
                    editMap.removeLayer(editMarker);
                }
                
                // Adiciona novo marcador
                editMarker = L.marker([lat, lng]).addTo(editMap);
                
                // Atualiza o campo de coordenadas
                document.getElementById('editDeviceGeoLocation').value = `${lat}, ${lng}`;
                
                // Mostra alerta de sucesso
                showGeoAlert(`Localização selecionada: ${lat}, ${lng}`, 'success', true);
            });
        }
        
        // Função para centralizar mapa em coordenadas específicas
        function centerMapOnCoordinates(coordinates, isEdit = false) {
            const coords = coordinates.split(',').map(coord => parseFloat(coord.trim()));
            if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                const map = isEdit ? editMap : createMap;
                const marker = isEdit ? editMarker : createMarker;
                
                if (map) {
                    map.setView([coords[0], coords[1]], 15);
                    
                    // Remove marcador anterior se existir
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    
                    // Adiciona novo marcador
                    const newMarker = L.marker([coords[0], coords[1]]).addTo(map);
                    if (isEdit) {
                        editMarker = newMarker;
                    } else {
                        createMarker = newMarker;
                    }
                }
            }
        }
        
        // Event listeners para inicializar mapas quando as abas são ativadas
        document.addEventListener('DOMContentLoaded', function() {
            // Aba do mapa de criação
            document.getElementById('map-tab').addEventListener('shown.bs.tab', function() {
                setTimeout(initCreateMap, 100);
            });
            
            // Aba do mapa de edição
            document.getElementById('edit-map-tab').addEventListener('shown.bs.tab', function() {
                setTimeout(initEditMap, 100);
            });
            
            // Listeners para atualizar mapas quando coordenadas são inseridas manualmente
            document.getElementById('deviceGeoLocation').addEventListener('blur', function() {
                if (this.value && createMap) {
                    centerMapOnCoordinates(this.value, false);
                }
            });
            
            document.getElementById('editDeviceGeoLocation').addEventListener('blur', function() {
                if (this.value && editMap) {
                    centerMapOnCoordinates(this.value, true);
                }
            });
        });
        
        // ===== FUNÇÕES DO MAPA DOS DISPOSITIVOS =====
        let devicesMap = null;
        let deviceMarkers = [];
        
        // Função para buscar dados dos dispositivos com coordenadas
        async function fetchDevicesForMap() {
            try {
                const resposta = await fetch(`${APP_CONFIG.API_BASE_URL}${APP_CONFIG.API_ENDPOINTS.DEVICES}`, {
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('token')
                    }
                });

                if (!resposta.ok) {
                    throw new Error('Erro ao carregar dispositivos');
                }

                const dispositivos = await resposta.json();
                
                // Filtrar apenas dispositivos com coordenadas válidas
                return dispositivos.filter(device => {
                    if (!device.geoLocation) return false;
                    const coords = device.geoLocation.split(',').map(coord => parseFloat(coord.trim()));
                    return coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1]);
                });
            } catch (error) {
                console.error('Erro ao buscar dispositivos:', error);
                mostrarAlerta('Erro ao carregar dispositivos para o mapa', 'danger');
                return [];
            }
        }
        
        // Função para inicializar o mapa dos dispositivos
        async function initDevicesMap() {
            if (devicesMap) {
                devicesMap.remove();
            }
            
            // Coordenadas padrão (Fortaleza, CE)
            devicesMap = L.map('devicesMap').setView([-3.7246997469328127, -38.52683830224771], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(devicesMap);
            
            // Buscar e adicionar dispositivos ao mapa
            const devices = await fetchDevicesForMap();
            addDevicesToMap(devices);
        }
        
        // Função para adicionar dispositivos ao mapa
        function addDevicesToMap(devices) {
            // Limpar marcadores existentes
            deviceMarkers.forEach(marker => devicesMap.removeLayer(marker));
            deviceMarkers = [];
            
            if (devices.length === 0) {
                mostrarAlerta('Nenhum dispositivo com localização encontrado', 'warning');
                return;
            }
            
            devices.forEach(device => {
                const coords = device.geoLocation.split(',').map(coord => parseFloat(coord.trim()));
                const lat = coords[0];
                const lng = coords[1];
                
                // Criar ícone personalizado baseado no status
                const iconClass = device.statusDevice ? 'device-marker-online' : 'device-marker-offline';
                const iconColor = device.statusDevice ? '#28a745' : '#dc3545';
                
                const customIcon = L.divIcon({
                    className: iconClass,
                    html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
                
                // Criar marcador
                const marker = L.marker([lat, lng], { icon: customIcon }).addTo(devicesMap);
                
                // Adicionar popup com informações do dispositivo
                const statusText = device.statusDevice ? 'Online' : 'Offline';
                const statusClass = device.statusDevice ? 'text-success' : 'text-danger';
                
                marker.bindPopup(`
                    <div class="p-2">
                        <h6 class="mb-2">${device.name}</h6>
                        <p class="mb-1"><small><strong>Tipo:</strong> ${device.type}</small></p>
                        <p class="mb-1"><small><strong>Chave:</strong> <code>${device.deviceKey}</code></small></p>
                        <p class="mb-1"><small><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></small></p>
                        <p class="mb-0"><small><strong>Localização:</strong> ${device.geoLocation}</small></p>
                    </div>
                `);
                
                deviceMarkers.push(marker);
            });
            
            // Ajustar visualização para mostrar todos os marcadores
            if (deviceMarkers.length > 0) {
                const group = new L.featureGroup(deviceMarkers);
                devicesMap.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Event listener para inicializar o mapa quando o modal é aberto
        document.getElementById('devicesMapModal').addEventListener('shown.bs.modal', function() {
            setTimeout(initDevicesMap, 100);
        });
    </script>
</body>

</html>